const fs = require('fs');
const path = require('path');

const root = path.resolve(__dirname, '..');
const configsDir = path.join(root, 'docs', 'config', 'exports');
const outPath = path.join(root, 'src', 'config', 'bundledFormConfigs.ts');

const listConfigFiles = () => {
  if (!fs.existsSync(configsDir)) return [];
  return fs
    .readdirSync(configsDir)
    .filter(fileName => fileName && fileName.toLowerCase().endsWith('.json'))
    .sort();
};

const parseConfigFile = fileName => {
  const fullPath = path.join(configsDir, fileName);
  let raw = '';
  try {
    raw = fs.readFileSync(fullPath, 'utf8');
  } catch (err) {
    console.error('[embed-form-configs] Failed reading', fullPath, err && err.message ? err.message : err);
    process.exit(1);
  }

  let parsed;
  try {
    parsed = JSON.parse(raw);
  } catch (err) {
    console.error('[embed-form-configs] Failed parsing JSON', fullPath, err && err.message ? err.message : err);
    process.exit(1);
  }

  if (!parsed || typeof parsed !== 'object') {
    console.error('[embed-form-configs] Invalid config object in', fullPath);
    process.exit(1);
  }

  if (!parsed.formKey || !parsed.formKey.toString().trim()) {
    parsed.formKey = fileName.replace(/\.json$/i, '');
  }

  return parsed;
};

const files = listConfigFiles();
const configs = files.map(parseConfigFile);

const banner =
  '// Auto-generated by scripts/embed-form-configs.js. Do not edit by hand.\n' +
  '// Contains exported form configurations embedded from /docs/config/exports.\n';

const output = `${banner}\nimport type { FormConfigExport } from '../types';\n\nexport const BUNDLED_FORM_CONFIGS = ${JSON.stringify(configs, null, 2)} as FormConfigExport[];\n`;

fs.mkdirSync(path.dirname(outPath), { recursive: true });
fs.writeFileSync(outPath, output, 'utf8');
console.info('[embed-form-configs] Embedded', configs.length, 'config(s) into', outPath);
