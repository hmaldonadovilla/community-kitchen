const fs = require('fs');
const path = require('path');

const root = path.resolve(__dirname, '..');
const args = process.argv.slice(2);

const readFlag = name => {
  const direct = args.find(arg => arg.startsWith(`--${name}=`));
  if (direct) return direct.slice(name.length + 3);
  const idx = args.indexOf(`--${name}`);
  if (idx >= 0 && idx < args.length - 1) return args[idx + 1];
  return null;
};

const normalizeEnvName = value => {
  const raw = (value || '').toString().trim().toLowerCase();
  if (!raw) return '';
  if (raw === 'production') return 'prod';
  return raw;
};

const resolveConfigEnv = () =>
  normalizeEnvName(
    readFlag('env') || readFlag('config-env') || process.env.CK_CONFIG_ENV || process.env.CK_ENV || process.env.DEPLOY_ENV
  );

const resolveConfigsDir = configEnv =>
  configEnv ? path.join(root, 'docs', 'config', 'exports', configEnv) : path.join(root, 'docs', 'config', 'exports');

const outPath = path.join(root, 'src', 'config', 'bundledFormConfigs.ts');

const listConfigFiles = configsDir => {
  if (!fs.existsSync(configsDir)) return [];
  return fs
    .readdirSync(configsDir)
    .filter(fileName => fileName && fileName.toLowerCase().endsWith('.json'))
    .sort();
};

const parseConfigFile = (configsDir, fileName) => {
  const fullPath = path.join(configsDir, fileName);
  let raw = '';
  try {
    raw = fs.readFileSync(fullPath, 'utf8');
  } catch (err) {
    console.error('[embed-form-configs] Failed reading', fullPath, err && err.message ? err.message : err);
    process.exit(1);
  }

  let parsed;
  try {
    parsed = JSON.parse(raw);
  } catch (err) {
    console.error('[embed-form-configs] Failed parsing JSON', fullPath, err && err.message ? err.message : err);
    process.exit(1);
  }

  if (!parsed || typeof parsed !== 'object') {
    console.error('[embed-form-configs] Invalid config object in', fullPath);
    process.exit(1);
  }

  if (!parsed.formKey || !parsed.formKey.toString().trim()) {
    parsed.formKey = fileName.replace(/\.json$/i, '');
  }

  return parsed;
};

const main = () => {
  const configEnv = resolveConfigEnv();
  const configsDir = resolveConfigsDir(configEnv);

  if (configEnv && !fs.existsSync(configsDir)) {
    console.error('[embed-form-configs] Missing config export dir for env:', configEnv, '->', configsDir);
    process.exit(1);
  }

  const files = listConfigFiles(configsDir);
  const configs = files.map(fileName => parseConfigFile(configsDir, fileName));

  const banner =
    '// Auto-generated by scripts/embed-form-configs.js. Do not edit by hand.\n' +
    `// Contains exported form configurations embedded from /docs/config/exports${configEnv ? `/${configEnv}` : ''}.\n`;

  const output = `${banner}\nimport type { FormConfigExport } from '../types';\n\nexport const BUNDLED_CONFIG_ENV = ${JSON.stringify(
    configEnv || ''
  )} as const;\nexport const BUNDLED_FORM_CONFIGS = ${JSON.stringify(configs, null, 2)} as FormConfigExport[];\n`;

  fs.mkdirSync(path.dirname(outPath), { recursive: true });
  fs.writeFileSync(outPath, output, 'utf8');
  console.info('[embed-form-configs] Embedded', configs.length, 'config(s) into', outPath);
};

if (require.main === module) {
  main();
}

module.exports = {
  normalizeEnvName,
  resolveConfigEnv,
  resolveConfigsDir,
  main
};
