const fs = require('fs');
const path = require('path');

const root = path.resolve(__dirname, '..');
const outPath = path.join(root, 'src', 'web', 'react', 'reactBundle.ts');
const distDir = path.join(root, 'dist');
const bundlePrefix = 'webform-react';
const files = fs
  .readdirSync(distDir)
  .filter(f => f && typeof f === 'string' && f.toLowerCase().endsWith('.js'))
  .filter(f => f.toLowerCase() === `${bundlePrefix}.js` || f.toLowerCase().startsWith(`${bundlePrefix}-`))
  .sort();

const bundles = {};
const fullFile = files.find((f) => f.toLowerCase() === `${bundlePrefix}.js`);
if (!fullFile) {
  console.error('[embed-react-bundle] Missing full bundle at', path.join(distDir, `${bundlePrefix}.js`));
  process.exit(1);
}

const fullPath = path.join(distDir, fullFile);
const fullBundle = fs.readFileSync(fullPath, 'utf8');
bundles.full = fullBundle;

files
  .filter((f) => f.toLowerCase() !== `${bundlePrefix}.js`)
  .forEach((fileName) => {
    const lower = fileName.toLowerCase();
    const key = lower.replace(`${bundlePrefix}-`, '').replace(/\.js$/i, '').trim();
    const bundlePath = path.join(distDir, fileName);
    if (!fs.existsSync(bundlePath)) return;
    const content = fs.readFileSync(bundlePath, 'utf8');
    if (content === fullBundle) {
      console.info('[embed-react-bundle] Bundle matches full; skipping duplicate:', key);
      return;
    }
    bundles[key] = content;
  });

const literal = JSON.stringify(bundles, null, 2);
const banner = `// Auto-generated by scripts/embed-react-bundle.js. Do not edit by hand.\n// Contains the React bundles served by the web app.\n`;
const output = `${banner}export const WEB_FORM_REACT_BUNDLES: Record<string, string> = ${literal};
export const WEB_FORM_REACT_BUNDLE: string = WEB_FORM_REACT_BUNDLES.full || '';
export const getReactBundle = (key?: string | null): string => {
  const k = (key || '').toString().trim().toLowerCase();
  if (!k || k === 'full') return WEB_FORM_REACT_BUNDLE;
  const direct = (WEB_FORM_REACT_BUNDLES as any)[k];
  return direct || WEB_FORM_REACT_BUNDLE;
};
`;

fs.mkdirSync(path.dirname(outPath), { recursive: true });
fs.writeFileSync(outPath, output, 'utf8');
console.info('[embed-react-bundle] Wrote React bundle to', outPath);
