<!--
  Community Kitchen - Ingredients Management (Summary HTML Template)

  - Keep placeholders intact (e.g., {{FIELD_ID}}).
  - Designed for in-app summary with clear label/value hierarchy.
-->

<style>
  .ck-summary-template {
    color: var(--text);
    font-family: var(--ck-font-family, system-ui);
    font-size: var(--ck-font-label);
    font-weight: 400;
    line-height: 1.45;
    margin: -8px;
  }

  .ck-summary-template * {
    box-sizing: border-box;
    max-width: 100%;
  }

  .ck-field-list {
    margin: 0;
    padding: 0;
    list-style: none;
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .ck-field-row {
    display: grid;
    grid-template-columns: minmax(160px, 1fr) minmax(0, 2fr);
    gap: 10px;
    align-items: start;
    border-bottom: 1px solid var(--border);
    padding-bottom: 10px;
  }

  .ck-field-row:last-child {
    border-bottom: none;
    padding-bottom: 0;
  }

  .ck-field-label {
    font-size: var(--ck-font-control);
    font-weight: 600;
    line-height: 1.3;
    color: var(--text);
  }

  .ck-field-value {
    font-size: var(--ck-font-label);
    font-weight: 400;
    line-height: 1.45;
    color: var(--text);
    word-break: break-word;
    overflow-wrap: anywhere;
    white-space: pre-wrap;
  }

  .ck-hidden-data {
    display: none;
  }

  @media (max-width: 640px) {
    .ck-field-row {
      grid-template-columns: 1fr;
      gap: 6px;
    }
  }
</style>

<div class="ck-summary-template" data-ck-template="ingredients-summary">
  <ul class="ck-field-list">
    <li class="ck-field-row">
      <div class="ck-field-label">{{LABEL(INGREDIENT_NAME)}}</div>
      <div class="ck-field-value">{{DEFAULT(INGREDIENT_NAME, "—")}}</div>
    </li>
    <li class="ck-field-row">
      <div class="ck-field-label">{{LABEL(CATEGORY)}}</div>
      <div class="ck-field-value">{{DEFAULT(CATEGORY, "—")}}</div>
    </li>
    <li class="ck-field-row">
      <div class="ck-field-label">{{LABEL(SUPPLIER)}}</div>
      <div class="ck-field-value">{{DEFAULT(SUPPLIER, "—")}}</div>
    </li>
    <li class="ck-field-row">
      <div class="ck-field-label">{{LABEL(ALLERGEN)}}</div>
      <div class="ck-field-value">{{DEFAULT(ALLERGEN, "—")}}</div>
    </li>
    <li class="ck-field-row">
      <div class="ck-field-label">{{LABEL(ALLOWED_UNIT)}}</div>
      <div class="ck-field-value">{{DEFAULT(ALLOWED_UNIT, "—")}}</div>
    </li>
    <li class="ck-field-row">
      <div class="ck-field-label">{{LABEL(DIETARY_APPLICABILITY)}}</div>
      <div class="ck-field-value">{{DEFAULT(DIETARY_APPLICABILITY, "—")}}</div>
    </li>
    <li class="ck-field-row">
      <div class="ck-field-label">{{LABEL(STATUS)}}</div>
      <div class="ck-field-value">{{DEFAULT(STATUS, "—")}}</div>
    </li>
    <li class="ck-field-row">
      <div class="ck-field-label">{{LABEL(CREATED_BY)}}</div>
      <div class="ck-field-value">{{DEFAULT(CREATED_BY, "—")}}</div>
    </li>
    <li class="ck-field-row" data-ck-changed-on-row>
      <div class="ck-field-label">Last changed on</div>
      <div class="ck-field-value" data-ck-changed-on>{{DEFAULT(UPDATED_AT, "—")}}</div>
    </li>
    <li class="ck-field-row" data-ck-changed-by-row>
      <div class="ck-field-label">{{LABEL(LAST_CHANGED_BY)}}</div>
      <div class="ck-field-value" data-ck-changed-by>{{DEFAULT(LAST_CHANGED_BY, "—")}}</div>
    </li>
  </ul>

  <div class="ck-hidden-data" aria-hidden="true">
    <span data-ck-status-raw>{{DEFAULT(STATUS, "")}}</span>
    <span data-ck-end-raw>{{DEFAULT(EFFECTIVE_END_DATE, "")}}</span>
    <span data-ck-updated-raw>{{DEFAULT(UPDATED_AT, "")}}</span>
    <span data-ck-last-changed-by-raw>{{DEFAULT(LAST_CHANGED_BY, "")}}</span>
  </div>
</div>

<script>
  (function () {
    var root = document.querySelector('[data-ck-template="ingredients-summary"]');
    if (!root || root.getAttribute('data-ck-init') === '1') return;
    root.setAttribute('data-ck-init', '1');

    var OPEN_END_ISO = '9999-12-31';
    var months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

    var text = function (selector) {
      var el = root.querySelector(selector);
      return (el && el.textContent ? el.textContent : '').toString().trim();
    };

    var setText = function (selector, value) {
      var el = root.querySelector(selector);
      if (!el) return;
      el.textContent = (value || '').toString();
    };

    var normalize = function (value) {
      return (value || '').toString().trim().toLowerCase();
    };

    var parseIsoDate = function (raw) {
      var value = (raw || '').toString().trim();
      if (!value) return null;
      var iso = value.match(/^(\d{4})-(\d{2})-(\d{2})/);
      if (!iso) return null;
      var year = Number(iso[1]);
      var month = Number(iso[2]);
      var day = Number(iso[3]);
      if (!Number.isFinite(year) || !Number.isFinite(month) || !Number.isFinite(day)) return null;
      if (month < 1 || month > 12 || day < 1 || day > 31) return null;
      return { year: year, month: month, day: day };
    };

    var formatDate = function (raw) {
      var value = (raw || '').toString().trim();
      if (!value) return '';
      if (/^\d{2}-[A-Za-z]{3}-\d{4}$/.test(value)) return value;
      var parsed = parseIsoDate(value);
      if (!parsed) return value;
      var monthLabel = months[parsed.month - 1] || '';
      if (!monthLabel) return value;
      var dd = parsed.day < 10 ? '0' + parsed.day : String(parsed.day);
      return dd + '-' + monthLabel + '-' + parsed.year;
    };

    var statusRaw = text('[data-ck-status-raw]');
    var endRaw = text('[data-ck-end-raw]');
    var updatedRaw = text('[data-ck-updated-raw]');
    var changedByRaw = text('[data-ck-last-changed-by-raw]');

    var statusKey = normalize(statusRaw);
    var formattedEnd = formatDate(endRaw);
    var normalizedEndRaw = normalize(endRaw);
    var normalizedFormattedEnd = normalize(formattedEnd);
    var isOpenEnded = normalizedEndRaw === OPEN_END_ISO ||
      normalizedFormattedEnd === normalize('31-Dec-9999') ||
      normalizedEndRaw.indexOf('9999-12-31') >= 0 ||
      normalizedEndRaw.indexOf('31-dec-9999') >= 0 ||
      normalizedFormattedEnd.indexOf('31-dec-9999') >= 0;

    if (statusKey === 'draft') {
      var draftRows = ['[data-ck-changed-on-row]', '[data-ck-changed-by-row]'];
      draftRows.forEach(function (selector) {
        var row = root.querySelector(selector);
        if (row) row.style.display = 'none';
      });
      return;
    }

    var changedOnValue = isOpenEnded ? 'N/A' : (formatDate(updatedRaw) || formatDate(endRaw) || '—');
    var changedByValue = isOpenEnded ? 'N/A' : (changedByRaw || '—');

    setText('[data-ck-changed-on]', changedOnValue);
    setText('[data-ck-changed-by]', changedByValue);
  })();
</script>
