openapi: 3.0.0
info:
  title: Community Kitchen Config Sheet Schema
  version: 1.0.0
  description: Schema definition for the Configuration Sheet used to generate forms.
paths: {}
components:
  schemas:
    QuestionConfig:
      type: object
      properties:
        id:
          type: string
          description: Unique identifier for the question (e.g., Q123). Generated automatically if missing.
        type:
          type: string
          enum: [DATE, TEXT, PARAGRAPH, NUMBER, CHOICE, CHECKBOX, FILE_UPLOAD, LINE_ITEM_GROUP]
          description: The type of the input field.
        qEn:
          type: string
          description: Question text in English.
        qFr:
          type: string
          description: Question text in French.
        qNl:
          type: string
          description: Question text in Dutch.
        required:
          type: boolean
          description: Whether the question is mandatory.
        options:
          type: string
          description: |
            Defines the options for CHOICE/CHECKBOX questions.
            Must be a reference string in the format `REF:SheetName` pointing to a separate sheet.
            The referenced sheet must contain three columns: Options (EN), Options (FR), Options (NL).
            Inline comma-separated lists are also supported for quick setup.
            Ignored for FILE_UPLOAD and LINE_ITEM_GROUP.
        optionFilter:
          $ref: '#/components/schemas/OptionFilter'
          description: Optional dependency to filter options based on other field value(s).
        validationRules:
          type: array
          items:
            $ref: '#/components/schemas/ValidationRule'
          description: Cross-field validation rules for this question.
        uploadConfig:
          $ref: '#/components/schemas/FileUploadConfig'
          description: Additional settings for FILE_UPLOAD questions. Provide as JSON in the `Config (JSON/REF)` column.
        lineItemConfig:
          $ref: '#/components/schemas/LineItemGroupConfig'
          description: Settings for LINE_ITEM_GROUP questions. Provide as JSON or `REF:SheetName` in the `Config (JSON/REF)` column.
        status:
          type: string
          enum: [Active, Archived]
          description: Status of the question. Archived questions are ignored during form generation.
      required:
        - id
        - type
        - qEn
        - qFr
        - qNl
        - required
        - status

    FileUploadConfig:
      type: object
      properties:
        destinationFolderId:
          type: string
          description: Optional Drive folder ID where uploaded files should be stored.
        maxFiles:
          type: integer
          description: Maximum number of files allowed for this upload question.
        maxFileSizeMb:
          type: number
          description: Maximum file size in MB. Files larger than this are ignored.
        allowedExtensions:
          type: array
          items:
            type: string
          description: List of allowed file extensions (e.g., ['jpg', 'png', 'pdf']).

    LineItemFieldConfig:
      type: object
      properties:
        id:
          type: string
          description: Internal identifier for the line item field.
        type:
          type: string
          enum: [DATE, TEXT, PARAGRAPH, NUMBER, CHOICE, CHECKBOX]
        labelEn:
          type: string
        labelFr:
          type: string
        labelNl:
          type: string
        required:
          type: boolean
        options:
          type: array
          items:
            type: string
        optionsFr:
          type: array
          items:
            type: string
        optionsNl:
          type: array
          items:
            type: string
        optionFilter:
          $ref: '#/components/schemas/OptionFilter'
          description: Optional dependency to filter options based on another line item field or a top-level field value.
        validationRules:
          type: array
          items:
            $ref: '#/components/schemas/ValidationRule'
          description: Cross-field validation rules inside the line item row.

    LineItemGroupConfig:
      type: object
      properties:
        minRows:
          type: integer
          description: Minimum number of line item rows required.
        maxRows:
          type: integer
          description: Maximum number of line item rows allowed.
        addButtonLabel:
          type: object
          properties:
            en:
              type: string
            fr:
              type: string
            nl:
              type: string
          description: Custom labels for the "Add line" button in each language.
        anchorFieldId:
          type: string
          description: ID of the line-item field used as anchor when bulk-adding rows.
        addMode:
          type: string
          enum: [overlay, inline]
          description: Use `overlay` to open a multi-select overlay for anchor choices when adding rows.
        fields:
          type: array
          items:
            $ref: '#/components/schemas/LineItemFieldConfig'
          description: |
            Line item field definitions. If `Config (JSON/REF)` uses `REF:SheetName`, the fields are pulled from that sheet (columns: ID, Type, Label EN/FR/NL, Required?, Options EN/FR/NL, Config JSON in column 10).
            The optional Config JSON column on that ref sheet can include `optionFilter` and `validationRules` for each line-item field.
            You can mix a `REF:SheetName` for field definitions with inline JSON in `Config (JSON/REF)` to set `addMode`, `addButtonLabel`, `anchorFieldId`, `minRows`, `maxRows`, and other group-level settings even when the fields themselves come from the ref sheet.
      required:
        - fields

    OptionFilter:
      type: object
      properties:
        dependsOn:
          oneOf:
            - type: string
            - type: array
              items:
                type: string
          description: |
            ID(s) of the field(s) whose value determines allowed options. Accepts a single ID or an ordered array for composite dependencies. When used inside line items, IDs can point to either sibling line-item fields or top-level fields.
        optionMap:
          type: object
          additionalProperties:
            type: array
            items:
              type: string
          description: |
            Mapping of parent value(s) -> allowed options for this field. For multiple dependencies, join values with `||` in the order listed in `dependsOn` (e.g., `"Carrots||Local"`). Use `"*"` as a fallback key.
      example:
        dependsOn: [Product, Supplier]
        optionMap:
          "Carrots||Local": [Crates]
          Carrots: [Bags, Crates]
          "*": [Bags]

    ValidationRule:
      type: object
      properties:
        when:
          type: object
          properties:
            fieldId:
              type: string
            equals:
              oneOf:
                - type: string
                - type: array
                  items:
                    type: string
            greaterThan:
              oneOf:
                - type: number
                - type: string
            lessThan:
              oneOf:
                - type: number
                - type: string
        then:
          type: object
          properties:
            fieldId:
              type: string
            required:
              type: boolean
              description: If true, target field must have a value when the condition matches.
            min:
              type: number
              description: Enforce target numeric value >= min.
            max:
              type: number
              description: Enforce target numeric value <= max.
            allowed:
              type: array
              items:
                type: string
            disallowed:
              type: array
              items:
                type: string
        message:
          oneOf:
            - type: string
            - type: object
              properties:
                en:
                  type: string
                fr:
                  type: string
                nl:
                  type: string
              additionalProperties:
                type: string
      required:
        - when
        - then
      description: Cross-field validation rule to enforce allowed/disallowed combinations.
      example:
        when:
          fieldId: Product
          equals: Carrots
        then:
          fieldId: Unit
          allowed: [Crates]
        message: Carrots must be recorded in crates.

    LineItemSheet:
      type: array
      description: |
        Structure of the separate sheet referenced by `REF:SheetName` for LINE_ITEM_GROUP questions.
        Columns should be: ID, Type, Label EN, Label FR, Label NL, Required?, Options (EN), Options (FR), Options (NL), Config JSON.
        Type must be one of DATE, TEXT, PARAGRAPH, NUMBER, CHOICE, CHECKBOX.
        The Config JSON (column 10) can optionally include `optionFilter` and/or `validationRules` per line-item field.
      items:
        type: object
        properties:
          id:
            type: string
          type:
            type: string
            enum: [DATE, TEXT, PARAGRAPH, NUMBER, CHOICE, CHECKBOX]
          labelEn:
            type: string
          labelFr:
            type: string
          labelNl:
            type: string
          required:
            type: boolean
          options:
            type: string
            description: Option values for CHOICE/CHECKBOX in English, or REF:Options_sheet.
          optionsFr:
            type: string
          optionsNl:
            type: string

    OptionsSheet:
      type: array
      description: |
        Structure of the separate sheet referenced by `REF:SheetName`.
        Contains three columns defining options in each language.
      items:
        type: object
        properties:
          optionEn:
            type: string
            description: Option text in English (Column A).
          optionFr:
            type: string
            description: Option text in French (Column B).
          optionNl:
            type: string
            description: Option text in Dutch (Column C).

    ConfigSheet:
      type: array
      description: A collection of question configurations defining a form.
      items:
        $ref: '#/components/schemas/QuestionConfig'
