openapi: 3.0.0
info:
  title: Community Kitchen Config Sheet Schema
  version: 1.0.0
  description: |
    Schema definition for the Configuration Sheet used to generate forms. The React web template is the only supported experience for deployed web apps; the legacy iframe UI has been retired, so no sheet-level configuration or query parameters are required for toggling views.
paths: {}
components:
  schemas:
    QuestionConfig:
      type: object
      properties:
        id:
          type: string
          description: Question identifier (e.g., `Q1`). Generated automatically if omitted.
        type:
          type: string
          enum: [DATE, TEXT, PARAGRAPH, NUMBER, CHOICE, CHECKBOX, FILE_UPLOAD, LINE_ITEM_GROUP, BUTTON]
          description: The type of the input field.
        qEn:
          type: string
          description: Question text in English.
        qFr:
          type: string
          description: Question text in French.
        qNl:
          type: string
          description: Question text in Dutch.
        required:
          type: boolean
          description: Whether the question is mandatory.
        requiredMessage:
          $ref: '#/components/schemas/LocalizedString'
          description: |
            Optional localized validation message used when this required field is empty.
            Supports `{field}` placeholder (resolved to the localized field label).
            For `FILE_UPLOAD` questions, this is used when the effective minimum is 1.
        defaultValue:
          $ref: '#/components/schemas/DefaultValue'
          description: |
            Optional default value used when creating a new record (or when the field is missing in a saved record).
            This only applies when the field is missing from the payload, so it does not override user edits.
            For dynamic prefills, prefer `derivedValue`.
        ui:
          $ref: '#/components/schemas/QuestionUiConfig'
          description: |
            Optional UI hints for how this question should render in the edit view.
            Most fields can stay on `auto` and the UI will choose an iOS-friendly control based on option count; you can override per field.
        readOnly:
          type: boolean
          description: |
            When `true`, this field is **read-only** in the Edit view (users cannot change it).

            Notes:
            - The value is still included in submissions.
            - Intended for fields set by `defaultValue`, `derivedValue`, or `createRecordPreset` buttons.
        optionSort:
          type: string
          enum: [alphabetical, source]
          description: |
            Optional option ordering override for this field (CHOICE/CHECKBOX).

            - `alphabetical` (default): sort by the localized label.
            - `source`: preserve the source order (as defined in config sheets / optionFilter / data sources).
        group:
          $ref: '#/components/schemas/QuestionGroupConfig'
          description: |
            Optional group card configuration for the edit view.
            Fields with the same group (by `id`, or by `title` if no `id` is provided) are rendered together inside a card section in the form body.
            If `collapsible` is enabled, the section can be collapsed/expanded by the user.
        pair:
          type: string
          description: |
            Optional "pair key" for explicit two-up layout.
            Fields with the same `pair` key will be rendered next to each other on the same row (when space permits).
            If `pair` is not set (or no matching pair is found), the field takes the full row.
        header:
          type: boolean
          deprecated: true
          description: |
            Deprecated. Use `group: { header: true, title: "Header" }` instead.
            Previously: when true, the edit view rendered this question in the sticky header area.
        options:
          type: string
          description: |
            Defines the options for CHOICE/CHECKBOX questions.
            Must be a reference string in the format `REF:SheetName` pointing to a separate sheet.
            The referenced sheet must contain three columns: Options (EN), Options (FR), Options (NL).
            Inline comma-separated lists are also supported for quick setup.
            Ignored for FILE_UPLOAD, LINE_ITEM_GROUP, and BUTTON.
            For CHECKBOX questions: when no options are provided (and no `dataSource` is set), the UI treats the field as a consent boolean and renders a single checkbox.
        optionFilter:
          $ref: '#/components/schemas/OptionFilter'
          description: Optional dependency to filter options based on other field value(s).
        valueMap:
          $ref: '#/components/schemas/ValueMapConfig'
          description: Readonly TEXT helper that derives its value from another field using a map (arrays join with ", ").
        dataSource:
          $ref: '#/components/schemas/DataSourceConfig'
          description: |
            Optional remote data source for options or prefills. Use when a question's options should come from a backend source instead of static options/ref sheets.
        selectionEffects:
          type: array
          items:
            $ref: '#/components/schemas/SelectionEffect'
          description: |
            Effects triggered when specific choices/checkbox values are selected (e.g., auto-add line items with prefilled values).
        validationRules:
          type: array
          items:
            $ref: '#/components/schemas/ValidationRule'
          description: Cross-field validation rules for this question.
        derivedValue:
          $ref: '#/components/schemas/DerivedValueConfig'
          description: Computed value helper (e.g., add days to a date). Useful for hidden/system fields like expiration dates.
        visibility:
          $ref: '#/components/schemas/VisibilityConfig'
          description: Show or hide this question based on another field value.
        changeDialog:
          $ref: '#/components/schemas/FieldChangeDialogConfig'
          description: |
            Optional field-level guarded change dialog. When configured, the edit view will prompt the
            user before applying changes that satisfy `changeDialog.when`. See FieldChangeDialogConfig
            for interaction details with autosave and dedup rules.
        clearOnChange:
          type: boolean
          description: If true, changing this field clears all other fields and line items.
        uploadConfig:
          $ref: '#/components/schemas/FileUploadConfig'
          description: Additional settings for FILE_UPLOAD questions. Provide as JSON in the `Config (JSON/REF)` column.
        lineItemConfig:
          $ref: '#/components/schemas/LineItemGroupConfig'
          description: Settings for LINE_ITEM_GROUP questions. Provide as JSON or `REF:SheetName` in the `Config (JSON/REF)` column.
        button:
          $ref: '#/components/schemas/ButtonConfig'
          description: |
            Configuration for BUTTON questions (UI-only actions).
            BUTTON questions do not persist values to the destination tab and are ignored by validation/progress.
        status:
          type: string
          enum: [Active, Archived]
          description: Status of the question. Archived questions are ignored during form generation.
        listViewSort:
          type: object
          description: |
            Optional list-view sort metadata applied when rendering saved submissions.

            If multiple questions have `listViewSort`, they are applied in ascending `priority` order
            (priority 1 = primary sort, priority 2 = tie-breaker, etc).
          properties:
            direction:
              type: string
              enum: [asc, desc]
            priority:
              type: integer
              description: Lower numbers are evaluated first.
        listView:
          type: boolean
          description: When true, this question appears in the list view.
        autoIncrement:
          type: object
          properties:
            prefix:
              type: string
            padLength:
              type: integer
            propertyKey:
              type: string
          description: Auto-generated ID metadata for TEXT fields.
      required: [id, type, qEn, qFr, qNl, required, status]

    ButtonConfig:
      description: UI-only button field configuration.
      oneOf:
        - type: object
          properties:
            action:
              type: string
              enum: [renderDocTemplate]
              description: |
                Render a Google Doc template (with placeholders + consolidated directives) into a PDF preview.

                Notes:
                - Use `{{DEFAULT(KEY, "fallback")}}` to render a fallback value when a placeholder is empty.
                - Generated rows inside `GROUP_TABLE` and `CONSOLIDATED_TABLE` outputs use alternating row background colors (zebra striping) automatically.
            templateId:
              $ref: '#/components/schemas/TemplateIdMap'
              description: Google Doc template id config (string, language map, or `cases` selector).
            output:
              type: string
              enum: [pdf]
              description: Output format. Currently only `pdf`.
            previewMode:
              type: string
              enum: [pdf, live]
              description: |
                Preview mode for the web app overlay.

                NOTE: The current UI always shows an **in-app PDF preview** (generated in-memory; no PDF file is written to Drive).
                `live` is deprecated/ignored and kept only for backward compatibility with older configs.
            loadingLabel:
              $ref: '#/components/schemas/LocalizedString'
              description: |
                Optional localized loading label shown while generating the PDF.

                When omitted, the UI falls back to the default system string (e.g. "Generating PDF…").
            placements:
              type: array
              items:
                type: string
                enum: [form, formSummaryMenu, summaryBar, topBar, topBarList, topBarForm, topBarSummary, listBar]
              description: |
                Where the button should surface in the web UI.
                - `form`: render inline as a normal field in the form view.
                - `formSummaryMenu`: appear inside the Summary button menu while editing.
                - `summaryBar`: appear in the bottom action bar on the Summary view (menu if multiple).
                - `topBar`: appear in the action bar directly under the header (all views).
                - `topBarList`: appear in the top action bar on the List view.
                - `topBarForm`: appear in the top action bar on the Form (edit) view.
                - `topBarSummary`: appear in the top action bar on the Summary view.
                - `listBar`: appear in the bottom action bar on the list view (menu if multiple).
            folderId:
              type: string
              description: Optional Drive folder id to write generated PDFs to (defaults to follow-up folder / spreadsheet parent).
          required: [action, templateId]
        - type: object
          properties:
            action:
              type: string
              enum: [renderMarkdownTemplate]
              description: |
                Render a Markdown template stored in Google Drive (plain text / .md) using the same placeholder rules
                as Doc templates (e.g., `{{FIELD_ID}}`, consolidated placeholders, etc), then show it immediately in-app.

                This is designed for a **single-click preview** experience (no Drive/Docs preview pages, no extra "Open" clicks).

                Placeholder helpers:
                - `{{DEFAULT(KEY, "fallback")}}`: use a fallback value when the referenced placeholder is empty.
                - Line-item data source columns can be referenced via `{{GROUP.FIELD.COLUMN_ID}}` or `{{GROUP.SUBGROUP.FIELD.COLUMN_ID}}`.
                - `GROUP_TABLE` supports nested subgroup paths, e.g. `{{GROUP_TABLE(PARENT.SUBGROUP.FIELD)}}`.
            templateId:
              $ref: '#/components/schemas/TemplateIdMap'
              description: Google Drive file id config (string, language map, or `cases` selector) for the Markdown template.
            placements:
              type: array
              items:
                type: string
                enum: [form, formSummaryMenu, summaryBar, topBar, topBarList, topBarForm, topBarSummary, listBar]
              description: |
                Where the button should surface in the web UI.
                - `form`: render inline as a normal field in the form view.
                - `formSummaryMenu`: appear inside the Summary button menu while editing.
                - `summaryBar`: appear in the bottom action bar on the Summary view (menu if multiple).
                - `topBar`: appear in the action bar directly under the header (all views).
                - `topBarList`: appear in the top action bar on the List view.
                - `topBarForm`: appear in the top action bar on the Form (edit) view.
                - `topBarSummary`: appear in the top action bar on the Summary view.
                - `listBar`: appear in the bottom action bar on the list view (menu if multiple).
          required: [action, templateId]
        - type: object
          properties:
            action:
              type: string
              enum: [renderHtmlTemplate]
              description: |
                Render an HTML template stored in Google Drive (text/html or text/plain) using the same placeholder rules
                as Doc templates (e.g., `{{FIELD_ID}}`, consolidated placeholders, line-item directives), then show it immediately in-app.

                This is designed for a **single-click preview** experience (no Drive/Docs preview pages, no extra "Open" clicks).

                Placeholder helpers:
                - `{{DEFAULT(KEY, "fallback")}}`: use a fallback value when the referenced placeholder is empty.

                HTML-only placeholder:
                - `{{FILES_ICON(FIELD_ID)}}`: replaced by a clickable file icon button (opens a read-only Files overlay).
            templateId:
              $ref: '#/components/schemas/TemplateIdMap'
              description: Google Drive file id config (string, language map, or `cases` selector) for the HTML template.
            placements:
              type: array
              items:
                type: string
                enum: [form, formSummaryMenu, summaryBar, topBar, topBarList, topBarForm, topBarSummary, listBar]
              description: |
                Where the button should surface in the web UI.
                - `form`: render inline as a normal field in the form view.
                - `formSummaryMenu`: appear inside the Summary button menu while editing.
                - `summaryBar`: appear in the bottom action bar on the Summary view (menu if multiple).
                - `topBar`: appear in the action bar directly under the header (all views).
                - `topBarList`: appear in the top action bar on the List view.
                - `topBarForm`: appear in the top action bar on the Form (edit) view.
                - `topBarSummary`: appear in the top action bar on the Summary view.
                - `listBar`: appear in the bottom action bar on the list view (menu if multiple).
          required: [action, templateId]
        - type: object
          properties:
            action:
              type: string
              enum: [createRecordPreset]
              description: Create a new record and prefill field values.
            presetValues:
              type: object
              additionalProperties:
                $ref: '#/components/schemas/DefaultValue'
              description: |
                Prefill values by field id (stored values, not localized labels).
                For CHOICE, use the underlying option value (typically the EN option key).
            placements:
              type: array
              items:
                type: string
                enum: [form, formSummaryMenu, summaryBar, topBar, topBarList, topBarForm, topBarSummary, listBar]
              description: |
                Where the button should surface in the web UI.
                - `form`: render inline as a normal field in the form view.
                - `formSummaryMenu`: appear inside the Summary button menu while editing.
                - `summaryBar`: appear in the bottom action bar on the Summary view (menu if multiple).
                - `topBar`: appear in the action bar directly under the header (all views).
                - `topBarList`: appear in the top action bar on the List view.
                - `topBarForm`: appear in the top action bar on the Form (edit) view.
                - `topBarSummary`: appear in the top action bar on the Summary view.
                - `listBar`: appear in the bottom action bar on the list view (menu if multiple).
          required: [action, presetValues]

        - type: object
          properties:
            action:
              type: string
              enum: [listViewSearchPreset]
              description: |
                Trigger a predefined search query in the list view (cards mode).
                These buttons render below the search bar when no search results are showing.
            mode:
              type: string
              enum: [text, date, advanced]
              description: Optional search mode override (defaults to `listView.search.mode`).
            keyword:
              type: string
              description: Keyword to search for (text or advanced modes).
            dateValue:
              type: string
              description: Date to search for (`YYYY-MM-DD`) when `mode` is `date`.
            fieldFilters:
              type: object
              additionalProperties:
                oneOf:
                  - type: string
                  - type: array
                    items:
                      type: string
              description: Advanced field filters (AND-ed together).
          required: [action]

        - type: object
          properties:
            action:
              type: string
              enum: [updateRecord]
              description: |
                Update an existing record (draft save) and optionally navigate to another view.

                Primary use case: **Re-open** a Closed record from the Summary view:
                - set `set.status` to a value different from `"Closed"`
                - set `navigateTo: "form"` so the user can resume editing.
            set:
              type: object
              properties:
                status:
                  oneOf:
                    - type: string
                    - type: 'null'
                  description: |
                    New Status value to write.

                    Notes:
                    - Writes to the configured follow-up `statusFieldId` when present; otherwise writes to the system Status column.
                    - When re-opening a Closed record, this must be different from `"Closed"`.
                values:
                  type: object
                  additionalProperties:
                    oneOf:
                      - $ref: '#/components/schemas/DefaultValue'
                      - type: 'null'
                  description: |
                    Optional field updates by question id.

                    Notes:
                    - Intended for top-level scalar fields only (TEXT/NUMBER/DATE/CHOICE/CHECKBOX).
                    - Does not support updating LINE_ITEM_GROUP/FILE_UPLOAD/BUTTON fields.
              required: []
              description: Fields to update.
            confirm:
              type: object
              properties:
                title:
                  oneOf:
                    - type: string
                    - type: object
                      additionalProperties:
                        type: string
                  description: Optional confirmation dialog title.
                message:
                  oneOf:
                    - type: string
                    - type: object
                      additionalProperties:
                        type: string
                  description: Confirmation dialog message.
                confirmLabel:
                  oneOf:
                    - type: string
                    - type: object
                      additionalProperties:
                        type: string
                  description: Optional confirm button label.
                cancelLabel:
                  oneOf:
                    - type: string
                    - type: object
                      additionalProperties:
                        type: string
                  description: Optional cancel button label.
              required: [message]
            navigateTo:
              type: string
              enum: [auto, form, summary, list]
              description: After a successful update, navigate to this view.
            placements:
              type: array
              items:
                type: string
                enum: [form, formSummaryMenu, summaryBar, topBar, topBarList, topBarForm, topBarSummary, listBar]
              description: |
                Where the button should surface in the web UI.
                - `form`: render inline as a normal field in the form view.
                - `formSummaryMenu`: appear inside the Summary button menu while editing.
                - `summaryBar`: appear in the bottom action bar on the Summary view (menu if multiple).
                - `topBar`: appear in the action bar directly under the header (all views).
                - `topBarList`: appear in the top action bar on the List view.
                - `topBarForm`: appear in the top action bar on the Form (edit) view.
                - `topBarSummary`: appear in the top action bar on the Summary view.
                - `listBar`: appear in the bottom action bar on the list view (menu if multiple).
          required: [action, set]

        - type: object
          properties:
            action:
              type: string
              enum: [openUrlField]
              description: |
                Open (redirect to) the URL stored in a field of the current record.

                Use this for quick access to saved PDFs, Drive links, or external resources.
            fieldId:
              type: string
              description: |
                Field id containing the URL.
                Can be a question id or a meta field like `pdfUrl`.
            placements:
              type: array
              items:
                type: string
                enum: [form, formSummaryMenu, summaryBar, topBar, topBarList, topBarForm, topBarSummary, listBar]
              description: |
                Where the button should surface in the web UI.
                - `form`: render inline as a normal field in the form view.
                - `formSummaryMenu`: appear inside the Summary button menu while editing.
                - `summaryBar`: appear in the bottom action bar on the Summary view (menu if multiple).
                - `topBar`: appear in the action bar directly under the header (all views).
                - `topBarList`: appear in the top action bar on the List view.
                - `topBarForm`: appear in the top action bar on the Form (edit) view.
                - `topBarSummary`: appear in the top action bar on the Summary view.
                - `listBar`: appear in the bottom action bar on the list view (menu if multiple).
          required: [action, fieldId]

    FileUploadConfig:
      type: object
      properties:
        destinationFolderId:
          type: string
          description: Optional Drive folder ID where uploaded files should be stored.
        minFiles:
          type: integer
          description: |
            Minimum number of files required for this field.

            - Enforced during submit validation (blocks submit when fewer than `minFiles` are attached).
            - Not enforced during draft autosave.
        maxFiles:
          type: integer
          description: Maximum number of files allowed for this upload question.
        maxFileSizeMb:
          type: number
          description: Maximum file size in MB (per file). Files larger than this are rejected by the web UI.
        allowedExtensions:
          type: array
          items:
            type: string
          description: List of allowed file extensions (e.g., ['jpg', 'png', 'pdf']). Dots are optional ('.jpg' also works).
        allowedMimeTypes:
          type: array
          items:
            type: string
          description: |
            Optional list of allowed MIME types (e.g., ['image/*', 'video/*', 'application/pdf']).
            When present, a file is allowed if it matches at least one MIME type OR one allowed extension.
        errorMessages:
          $ref: '#/components/schemas/FileUploadErrorMessages'
          description: Optional per-field localized overrides for upload validation messages.
        helperText:
          $ref: '#/components/schemas/FileUploadHelperText'
          description: |
            Optional helper text shown under the upload control (e.g. remaining attachments).
            Supports template variables like `{count}`.
            When omitted, the UI falls back to the built-in system strings (`files.remainingOne` / `files.remainingMany`).
        linkLabel:
          $ref: '#/components/schemas/LocalizedString'
          description: |
            Optional localized label template for links shown for uploaded items (Summary/PDF).

            Example:
            - `{ "en": "Photo {n}", "fr": "Photo {n}", "nl": "Foto {n}" }`

            Variables:
            - `{n}`: 1-based index of the file within this field
        ui:
          $ref: '#/components/schemas/FileUploadUiConfig'
          description: Optional UI customization for how the upload control is rendered.
        compression:
          $ref: '#/components/schemas/FileUploadCompressionConfig'
          description: Optional client-side compression settings applied before upload.
      description: |
        Upload settings consumed by FILE_UPLOAD questions. The React UI renders drag-and-drop dropzones that enforce these caps, show remaining slots + total size, and announce state changes for assistive tech. When `CK_DEBUG` (and thus `__WEB_FORM_DEBUG__`) is enabled the form also emits `[ReactForm] upload.*` diagnostics in DevTools for every add/drop/remove.

    FileUploadHelperText:
      oneOf:
        - $ref: '#/components/schemas/LocalizedString'
        - $ref: '#/components/schemas/FileUploadHelperTextConfig'
      description: |
        Helper text configuration for FILE_UPLOAD UI.
        - Use a single `LocalizedString` to apply the same template for any remaining count.
        - Or use the object form to customize singular vs plural.

    FileUploadHelperTextConfig:
      type: object
      properties:
        remainingOne:
          $ref: '#/components/schemas/LocalizedString'
          description: |
            Helper text when exactly 1 slot remains. Variables: {count}
        remainingMany:
          $ref: '#/components/schemas/LocalizedString'
          description: |
            Helper text when 2+ slots remain. Variables: {count}
      description: Optional per-field overrides for remaining-slot helper text.

    FileUploadUiConfig:
      type: object
      properties:
        variant:
          type: string
          enum: [standard, progressive]
          description: |
            Visual variant for the upload control.
            - `standard`: existing dropzone + Files button.
            - `progressive`: show camera slots (based on `minFiles`/`required`) with checkmarks as files are added.
        slotIcon:
          type: string
          enum: [camera, clip]
          description: |
            Icon used for the progressive slots.
            - `camera`: camera icon (good for photo requirements).
            - `clip`: paperclip icon (good for generic file attachments).
      description: Optional UI customization for FILE_UPLOAD controls.

    FileUploadErrorMessages:
      type: object
      properties:
        minFiles:
          $ref: '#/components/schemas/LocalizedString'
          description: |
            Message shown when fewer than `minFiles` are attached.
            Variables: {field}, {min}, {plural}
        maxFiles:
          $ref: '#/components/schemas/LocalizedString'
          description: |
            Message shown when more than `maxFiles` are attached.
            Variables: {field}, {max}, {plural}
        maxFileSizeMb:
          $ref: '#/components/schemas/LocalizedString'
          description: |
            Message shown when a selected file exceeds `maxFileSizeMb`.
            Variables: {name}, {mb}
        fileType:
          $ref: '#/components/schemas/LocalizedString'
          description: |
            Message shown when a selected file does not match `allowedExtensions`/`allowedMimeTypes`.
            Variables: {name}, {ext}, {exts}, {type}, {types}
        compressFailed:
          $ref: '#/components/schemas/LocalizedString'
          description: |
            Message used when client-side image compression fails (best-effort).
            Variables: {name}
      description: Optional per-field localized overrides for upload validation messages.

    FileUploadCompressionConfig:
      oneOf:
        - type: boolean
          description: |
            Convenience form: when true, enables default image compression.
            Equivalent to `{ "images": true }`.
        - type: object
          properties:
            images:
              oneOf:
                - type: boolean
                  description: When true, enable default image compression (resize + re-encode when smaller).
                - type: object
                  properties:
                    enabled:
                      type: boolean
                      description: Enable/disable image compression (defaults to true when object form is used).
                    maxDimension:
                      type: integer
                      description: Maximum width/height in pixels after resizing (default 1600).
                    quality:
                      type: number
                      description: JPEG/WebP quality (0..1, default 0.82). Ignored for PNG output.
                    outputType:
                      type: string
                      enum: [keep, image/jpeg, image/webp]
                      description: |
                        Output MIME type for compressed images.
                        - keep: keep the original image type when possible (default)
                        - image/jpeg: re-encode to JPEG (smaller, lossy)
                        - image/webp: re-encode to WebP (smaller, lossy)
            videos:
              type: boolean
              description: |
                When true, attempts to enable video compression. Note: video transcoding is not currently performed by the web app (videos upload as-is); prefer enforcing `maxFileSizeMb` for videos.
          additionalProperties: false
      description: Optional client-side compression settings applied before upload.

    DefaultValue:
      oneOf:
        - type: string
        - type: number
        - type: boolean
        - type: array
          items:
            type: string
      description: |
        Default value used to prefill a field when it is missing from the payload (new record/new row).
        Does not override user edits once the field exists in the payload.
        Notes:
        - CHOICE: use the stored option value (usually the EN option string).
        - CHECKBOX:
          - consent checkbox (no options + no dataSource): boolean
          - multi-select checkbox: array of strings (or a comma-separated string for convenience).

    LineItemFieldConfig:
      type: object
      properties:
        id:
          type: string
          description: Internal identifier for the line item field.
        type:
          type: string
          enum: [DATE, TEXT, PARAGRAPH, NUMBER, CHOICE, CHECKBOX, FILE_UPLOAD]
        labelEn:
          type: string
        labelFr:
          type: string
        labelNl:
          type: string
        placeholder:
          oneOf:
            - type: string
            - $ref: '#/components/schemas/LocalizedString'
          description: Optional placeholder text for the selector input.
        placeholderEn:
          type: string
        placeholderFr:
          type: string
        placeholderNl:
          type: string
        required:
          type: boolean
        requiredMessage:
          $ref: '#/components/schemas/LocalizedString'
          description: |
            Optional localized validation message used when this required field is empty.
            Supports `{field}` placeholder (resolved to the localized field label).
            For `FILE_UPLOAD` line-item fields, this is used when the effective minimum is 1.
        defaultValue:
          $ref: '#/components/schemas/DefaultValue'
          description: |
            Optional default value used when creating a new row (manual/auto/selectionEffect) or when the field is missing.
            This only applies when the field is missing from the row payload, so it does not override user edits.
            For dynamic prefills, prefer `derivedValue`.
        ui:
          $ref: '#/components/schemas/QuestionUiConfig'
          description: Optional UI hints for how this line item field should render (e.g., use segmented/radio/select for CHOICE).
        readOnly:
          type: boolean
          description: |
            When `true`, this line item field is **read-only** in the Edit view (users cannot change it).

            Notes:
            - The value is still included in submissions.
            - Intended for fields set by `defaultValue`, `derivedValue`, or auto/preset row generation.
        optionSort:
          type: string
          enum: [alphabetical, source]
          description: |
            Optional option ordering override for this field (CHOICE/CHECKBOX).

            - `alphabetical` (default): sort by the localized label.
            - `source`: preserve the source order (as defined in config sheets / optionFilter / data sources).
        group:
          $ref: '#/components/schemas/QuestionGroupConfig'
          description: |
            Optional group card configuration for the edit view inside a line-item row (or subgroup overlay).
            Fields with the same group (by `id`, or by `title` if no `id` is provided) are rendered together inside a card section.
        pair:
          type: string
          description: |
            Optional "pair key" for explicit two-up layout inside line-item rows and subgroup overlays.
            Fields with the same `pair` key will be rendered next to each other on the same row (when space permits).
            If `pair` is not set (or no matching pair is found), the field takes the full row.
        options:
          type: array
          items:
            type: string
        optionsFr:
          type: array
          items:
            type: string
        optionsNl:
          type: array
          items:
            type: string
        optionFilter:
          $ref: '#/components/schemas/OptionFilter'
          description: Optional dependency to filter options based on another line item field or a top-level field value.
        validationRules:
          type: array
          items:
            $ref: '#/components/schemas/ValidationRule'
          description: Cross-field validation rules inside the line item row.
        derivedValue:
          $ref: '#/components/schemas/DerivedValueConfig'
          description: Computed value helper for a line-item field (e.g., auto-calc expiry per row).
        visibility:
          $ref: '#/components/schemas/VisibilityConfig'
          description: Show/hide logic for this line item field based on another value.
        changeDialog:
          $ref: '#/components/schemas/FieldChangeDialogConfig'
          description: |
            Optional field-level guarded change dialog for this line item field.
            When configured, the edit view will prompt the user before applying changes that satisfy `changeDialog.when`.
        dataSource:
          $ref: '#/components/schemas/DataSourceConfig'
          description: Optional data source for CHOICE/CHECKBOX line-item fields. When present, options are hydrated just like top-level questions.
        selectionEffects:
          type: array
          items:
            $ref: '#/components/schemas/SelectionEffect'
          description: Selection effects supported on line-item fields (triggered per row once required fields are complete).
        valueMap:
          $ref: '#/components/schemas/ValueMapConfig'
          description: Readonly TEXT helper that derives its value from another field using a map (arrays join with ", ").
        uploadConfig:
          $ref: '#/components/schemas/FileUploadConfig'
          description: Additional settings for FILE_UPLOAD line-item fields.

    LineItemGroupConfig:
      type: object
      properties:
        id:
          type: string
          description: |
            Stable subgroup identifier.

            - Required for entries inside `lineItemConfig.subGroups` (subgroup keys are ID-based).
            - Typically omitted for the top-level `lineItemConfig` because the parent question’s `id` is used as the group key.
        label:
          $ref: '#/components/schemas/LocalizedString'
          description: Optional label/template for this value (supports {{value}} placeholder).
        ui:
          $ref: '#/components/schemas/LineItemGroupUiConfig'
          description: Optional UI settings for how line item rows are rendered (e.g., progressive disclosure).
        minRows:
          type: integer
          description: Minimum number of line item rows required.
        maxRows:
          type: integer
          description: Maximum number of line item rows allowed.
        addButtonLabel:
          $ref: '#/components/schemas/LocalizedString'
          description: Custom labels for the "Add line" button in each language.
        anchorFieldId:
          type: string
          description: ID of the line-item field used as anchor when bulk-adding rows.
        addMode:
          type: string
          enum: [overlay, selectorOverlay, inline, auto]
          description: |
            How rows are added for this line-item group.
            - overlay: open a multi-select overlay for the anchor CHOICE field, then create one row per selected value.
            - selectorOverlay: use the section selector as a searchable multi-select list for the anchor CHOICE field (no separate Add button). Search indexes include extra columns from `optionsRef` / data sources.
            - auto: automatically add/recompute rows when the anchor field's `optionFilter.dependsOn` fields are filled (one row per allowed anchor option). Auto-generated rows are overwritten when dependencies change, while manual rows are preserved.
            - inline: default; show a simple "Add line" button and create an empty row per click.
        addOverlay:
          $ref: '#/components/schemas/LineItemAddOverlayConfig'
          description: |
            Optional copy overrides for the multi-select add overlay (used when `addMode: "overlay"`).
        sectionSelector:
          $ref: '#/components/schemas/LineItemSelectorConfig'
          description: Optional selector rendered above the line items to scope filters/validation rules (options can come from a REF tab).
        dedupRules:
          type: array
          items:
            $ref: '#/components/schemas/LineItemDedupRule'
          description: |
            Optional row-level de-duplication rules. Each rule defines the field ids that must be unique together
            within a line-item group or subgroup. Dedup checks run only once all listed fields have values.
        totals:
          type: array
          items:
            $ref: '#/components/schemas/LineItemTotalConfig'
          description: Totals to show under the line items (sum numeric fields or count rows).
        fields:
          type: array
          items:
            $ref: '#/components/schemas/LineItemFieldConfig'
          description: |
            Line item field definitions. If `Config (JSON/REF)` uses `REF:SheetName`, the fields are pulled from that sheet (columns: ID, Type, Label EN/FR/NL, Required?, Options EN/FR/NL, Config JSON in column 10).
            The optional Config JSON column on that ref sheet can include `optionFilter` and `validationRules` for each line-item field.
            You can mix a `REF:SheetName` for field definitions with inline JSON in `Config (JSON/REF)` to set `addMode`, `addButtonLabel`, `anchorFieldId`, `minRows`, `maxRows`, and other group-level settings even when the fields themselves come from the ref sheet.
        subGroups:
          type: array
          description: |
            Optional nested line-item groups that render under each parent row (e.g., Ingredients under each Dish header).
            Each child supports the same structure as `LineItemGroupConfig` (min/max/addMode/fields/optionFilter/selectionEffects/totals)
            and may also specify `ref: "REF:TabName"` to load its fields from a ref sheet (same column format as parent line-item refs);
            inline values override the ref.
            **Important:** Each subgroup entry must define a stable `id` (label-based subgroup keys are not supported).

            The web UI renders each subgroup with a localized title (from `label`, falling back to `id`) and a per-row Show/Hide toggle to collapse or expand its contents without affecting stored data.
            In progressive edit mode (`ui.mode: "progressive"`), subgroup rows are edited in a full-page overlay opened from buttons next to triggering fields (selection effects) or fallback subgroup buttons.
          items:
            $ref: '#/components/schemas/LineItemGroupConfig'
      required: [fields]

    LineItemCollapsedFieldConfig:
      type: object
      properties:
        fieldId:
          type: string
          description: Line item field ID to show in collapsed view.
        showLabel:
          type: boolean
          description: When false, omit the label in collapsed view (control/value only). Defaults to true.
      required: [fieldId]

    QuestionUiConfig:
      type: object
      properties:
        control:
          type: string
          enum: [auto, select, radio, segmented, switch]
          description: |
            Control variant for CHOICE fields (and optional select override for CHECKBOX fields).
            - auto: choose iOS-friendly defaults (segmented for <=3, radio for <=6, else select; boolean-like non-required choices may render as switch)
            - select: native dropdown (best for long option lists)
            - radio: radio list
            - segmented: iOS segmented control
            - switch: iOS switch (recommended only for boolean/non-required CHOICE fields)

            CHECKBOX notes:
            - For CHECKBOX fields with options (multi-select), `control: "select"` renders a native multi-select dropdown (`<select multiple>`).
            - For consent CHECKBOX fields (no options), the UI always renders a tick box.
        labelLayout:
          type: string
          enum: [auto, stacked]
          description: |
            Label/control layout hint.
            - auto: default behavior (inline on full-width rows; stacked in 2-up grids)
            - stacked: force label above control even for full-width rows
        hideLabel:
          type: boolean
          description: |
            When true, visually hide the field label in the edit view (kept for accessibility).

            Use sparingly: labels help users understand fields. This is mainly useful when a field is already
            clearly explained by surrounding UI, or when you render your own label elsewhere.
        helperText:
          $ref: '#/components/schemas/LocalizedString'
          description: |
            Optional helper text shown for this field.

            Use `helperPlacement` to choose whether it renders below the field label/control (default)
            or inside the control as a placeholder (when supported).
        helperPlacement:
          type: string
          enum: [belowLabel, placeholder]
          description: |
            Where to render `helperText`.
            - `belowLabel`: render as supporting text below the field control (default)
            - `placeholder`: render inside the control as a placeholder (when supported; falls back to belowLabel)
        summaryHideLabel:
          type: boolean
          description: |
            Summary-only override for label visibility (native React Summary view).

            - When omitted, Summary inherits from `hideLabel`.
            - When `true`, hide the label in the native Summary view (kept for accessibility).
            - When `false`, show the label in the native Summary view (even if `hideLabel` is true).

            Note: This applies to the built-in React Summary view (`ReportLivePreview`). It does not affect custom HTML templates.
        summaryVisibility:
          type: string
          enum: [inherit, always, never]
          description: |
            Whether this field should appear in the Summary view.
            - inherit: follow normal `visibility` rules (default; only show when visible in the Form view)
            - always: show even if hidden by `visibility`
            - never: never show in summary (even if visible in form)
        paragraphRows:
          type: integer
          minimum: 2
          maximum: 20
          description: |
            For `PARAGRAPH` fields, controls the textarea height (visible rows).
            Default when omitted: 4.
        paragraphDisclaimer:
          $ref: '#/components/schemas/ParagraphDisclaimerConfig'
          description: |
            Optional disclaimer section appended to PARAGRAPH fields based on line-item warnings.
            The UI renders the disclaimer below the textarea by default (non-editable) and keeps the stored value in sync.
            Set `paragraphDisclaimer.editable: true` to render it inside the textarea for editing.
        choiceSearchEnabled:
          type: boolean
          description: |
            For `CHOICE` fields rendered as a select, enable a type-to-search input for long option lists.

            - When `true`, always use the searchable control (even for smaller lists)
            - When `false`, always use the native select (no search)
            - When omitted, the UI enables it automatically only for large option sets
        overlayOpenActions:
          type: array
          items:
            $ref: '#/components/schemas/LineItemOverlayOpenActionConfig'
          description: |
            Optional field-driven overlay open actions. When configured, the field can render as a button
            (after `when` matches) to open a line-item group overlay with optional row filters + UI overrides.

    ParagraphDisclaimerConfig:
      type: object
      required: [sourceGroupId]
      properties:
        sourceGroupId:
          type: string
          description: Line item group id to scan for `__ckNonMatchOptions`.
        sourceSubGroupId:
          type: string
          description: Optional subgroup id to scan (aggregates all rows across parent rows).
        itemFieldId:
          type: string
          description: Line item field id to use as the item label (defaults to anchorFieldId or first field).
        title:
          $ref: '#/components/schemas/LocalizedString'
          description: Optional section title shown before the disclaimer bullets.
        listMessage:
          $ref: '#/components/schemas/LocalizedString'
          description: |
            Template for each mismatch line. Supports placeholders:
            - {key} / {value}: the non-satisfied restriction key
            - {items} / {keys}: the list of items that do not satisfy it
        message:
          $ref: '#/components/schemas/LocalizedString'
          description: Optional extra bullet shown after the per-key list.
        separator:
          type: string
          description: |
            Optional separator line inserted before the disclaimer section (default: "---").
        editable:
          type: boolean
          description: |
            When true, render the disclaimer inside the textarea so it can be edited.
            Defaults to false (non-editable disclaimer block).
      example:
        sourceGroupId: INGREDIENTS
        title:
          en: "Pay attention to:"
        listMessage:
          en: "For {key}, do not use: {items}."
        message:
          en: "Remember to add salt only after reserving non-salt portions."

    QuestionGroupConfig:
      type: object
      properties:
        id:
          type: string
          description: Optional stable group id. Recommended if you have multiple groups.
        header:
          type: boolean
          description: |
            Marks this as the "header group" (fields previously rendered in the sticky header).
            Header groups render in the form body as a collapsible card section.
        title:
          $ref: '#/components/schemas/LocalizedString'
          description: Optional group title shown in the card header.
        collapsible:
          type: boolean
          description: When true, the group card can be collapsed/expanded. Defaults to true when title is set.
        defaultCollapsed:
          type: boolean
          description: Initial collapsed state (only applies when collapsible is true). Defaults to false.
        pageSection:
          $ref: '#/components/schemas/PageSectionConfig'
          description: |
            Optional higher-level page section wrapper for **visual guidance** in the Edit (form) view.

            When set, consecutive group cards that share the same pageSection (by `id`, or by `title` if no `id` is provided)
            are rendered under a shared section header (title + optional right-side info text).

            Notes:
            - This does not affect validation or submission payloads.
            - Header groups (`group.header: true`) are not wrapped in page sections.

    PageSectionConfig:
      type: object
      required: [title]
      properties:
        id:
          type: string
          description: Optional stable page section id. Recommended when multiple groups share the same section.
        title:
          $ref: '#/components/schemas/LocalizedString'
          description: Section title shown above a set of group cards in the Edit (form) view.
        infoText:
          $ref: '#/components/schemas/LocalizedString'
          description: Optional informational text shown on the right side of the section header (Edit view only).

    LineItemGroupUiConfig:
      type: object
      properties:
        mode:
          type: string
          enum: [default, progressive, table]
          description: |
            UI mode for this line item group.
            - default: existing editor behavior
            - progressive: rows are collapsed by default and can be expanded once collapsed fields are valid
            - table: compact table layout with one row per line item
        tableColumns:
          type: array
          items:
            type: string
          description: |
            Optional ordered list of field ids to render as columns when `mode: "table"`.
        tableColumnWidths:
          type: object
          additionalProperties:
            oneOf:
              - type: string
              - type: number
          description: |
            Optional per-column widths for table mode. Keys should match field ids, plus action keys:
            `__remove`, `__view`, `__edit` (action columns) and `_remove`, `_view`, `_edit` (overlay header aliases).
            Values can be CSS widths (e.g., "50%", "120px") or numbers (treated as percent).
        nonMatchWarningMode:
          type: string
          enum: [descriptive, validation, both]
          description: |
            Controls how non-match option warnings are shown in the table legend.
            - descriptive: show per-row optionFilter warnings listing which dependency keys were not satisfied
            - validation: show warning messages from validationRules (e.g., __ckNonMatchOptions) instead
            - both: show both (deduped)
        tableHideUntilAnchor:
          type: boolean
          description: |
            When true (default), hide non-anchor columns until the anchor field has a value.
            Useful when rows are created by selecting the anchor value first (e.g., ingredients).
        openInOverlay:
          type: boolean
          description: |
            When true, the **entire line item group** editor is opened in a full-page overlay (similar to subgroup overlays),
            and the main form shows a compact "Open" card instead of rendering the full table inline.

            Default: false (render inline).
        closeButtonLabel:
          $ref: '#/components/schemas/LocalizedString'
          description: |
            Optional label override for the overlay close button when `openInOverlay: true`.

            Notes:
            - Overlay openers (e.g. `ui.overlayOpenActions` / rowFlow `openOverlay`) can also provide their own `closeButtonLabel`.
            - Opener-level values take precedence over this per-group default.
        closeConfirm:
          oneOf:
            - $ref: '#/components/schemas/RowFlowActionConfirmConfig'
            - $ref: '#/components/schemas/OverlayCloseConfirmConfig'
          description: |
            Optional confirm dialog shown when closing the overlay when `openInOverlay: true`.

            Notes:
            - Overlay openers (e.g. `ui.overlayOpenActions` / rowFlow `openOverlay`) can also provide their own `closeConfirm`.
            - Opener-level values take precedence over this per-group default.
        overlayDetail:
          $ref: '#/components/schemas/LineItemOverlayDetailConfig'
          description: |
            Optional header/body overlay layout for full-page line item group overlays.
            Requires `openInOverlay: true` to take effect.
        choiceSearchEnabled:
          type: boolean
          description: |
            Default CHOICE search behavior for all CHOICE fields in this group (and its subgroups when configured there),
            unless a specific field overrides it via `field.ui.choiceSearchEnabled`.

            - When `true`, always use the searchable control for CHOICE selects
            - When `false`, always use the native select (no search)
            - When omitted, the UI enables search automatically only for large option sets
        showItemPill:
          type: boolean
          description: |
            Controls whether the items pill is shown in the line item group header.
            Default: true.
        addButtonPlacement:
          type: string
          enum: [top, bottom, both, hidden]
          description: |
            Controls where the "Add" button is shown for the group (and for subgroups when configured there).
            - top: header toolbar only
            - bottom: footer toolbar only
            - both: header + footer (default)
            - hidden: hide the button entirely
        allowRemoveAutoRows:
          type: boolean
          description: |
            Controls whether rows marked as auto-generated (`__ckRowSource: "auto"`) can be removed in the UI.

            - When `false`, the **Remove** button is hidden for auto rows (manual rows remain removable).
            - Default: `true`.
        saveDisabledRows:
          type: boolean
          description: |
            Controls whether "disabled" progressive rows are persisted on submit.

            A row is considered disabled when:
            - `mode: "progressive"`
            - `expandGate: "collapsedFieldsValid"`
            - the row is still collapsed AND its collapsed fields are missing/invalid

            - When `false` (default), these rows are filtered out of the submission payload.
            - When `true`, they are included in the saved record (useful when you want them to appear in downstream PDFs).
        collapsedFields:
          type: array
          items:
            $ref: '#/components/schemas/LineItemCollapsedFieldConfig'
          description: |
            Field(s) rendered (and editable) while a row is collapsed. Typically 1–2 fields to keep the list compact.
        expandGate:
          type: string
          enum: [collapsedFieldsValid, always]
          description: |
            Controls when the expand toggle is enabled.
            - collapsedFieldsValid: enabled only when collapsedFields are filled and pass configured validation/visibility rules
            - always: always enabled
            When combined with `addMode: auto`, rows that are still gated/disabled are ignored during submit validation, and required LINE_ITEM_GROUP questions require at least one enabled+valid row.
        defaultCollapsed:
          type: boolean
          description: Default collapsed state for each row. When omitted and mode=progressive, defaults to true.
        rowDisclaimer:
          $ref: '#/components/schemas/RowDisclaimerConfig'
          description: |
            Optional per-row disclaimer shown in the UI (works for both line item groups and subgroups).
            Supports localization and simple template interpolation using row field values.

            - Use `{{FIELD_ID}}` to insert a row field value.
            - Includes `{{__ckRowSource}}` (auto/manual) and `{{__ckRowSourceLabel}}` (localized).
        needsAttentionMessage:
          $ref: '#/components/schemas/LocalizedString'
          description: Optional localized helper shown when this line item group or subgroup needs attention.

    LineItemOverlayDetailConfig:
      type: object
      properties:
        enabled:
          type: boolean
          description: When true, enable header/body overlay layout for this group.
        header:
          $ref: '#/components/schemas/LineItemOverlayDetailHeaderConfig'
        body:
          $ref: '#/components/schemas/LineItemOverlayDetailBodyConfig'
        rowActions:
          $ref: '#/components/schemas/LineItemOverlayDetailRowActionsConfig'
      additionalProperties: false

    LineItemOverlayDetailHeaderConfig:
      type: object
      properties:
        tableColumns:
          type: array
          items:
            type: string
          description: Optional ordered list of field ids to render as columns in the header table.
        tableColumnWidths:
          type: object
          additionalProperties:
            oneOf:
              - type: string
              - type: number
          description: |
            Optional per-column widths for the header table. Keys should match field ids plus action keys:
            `__view`, `__edit`, `__remove` (and `_view`, `_edit`, `_remove` aliases).
        addButtonPlacement:
          type: string
          enum: [top, bottom, both, hidden]
          description: Controls where the Add button is shown for header rows.
      additionalProperties: false

    LineItemOverlayDetailBodyConfig:
      type: object
      required: [subGroupId]
      properties:
        subGroupId:
          type: string
          description: Subgroup id to render in the overlay body section.
        edit:
          $ref: '#/components/schemas/LineItemOverlayDetailBodyEditConfig'
        view:
          $ref: '#/components/schemas/LineItemOverlayDetailBodyViewConfig'
      additionalProperties: false

    LineItemOverlayDetailBodyEditConfig:
      type: object
      properties:
        mode:
          type: string
          enum: [table]
          description: Rendering mode for body edit view (table only).
        tableColumns:
          type: array
          items:
            type: string
        tableColumnWidths:
          type: object
          additionalProperties:
            oneOf:
              - type: string
              - type: number
      additionalProperties: false

    LineItemOverlayDetailBodyViewConfig:
      type: object
      properties:
        mode:
          type: string
          enum: [html]
          description: Rendering mode for body view (html template).
        templateId:
          $ref: '#/components/schemas/TemplateIdMap'
        hideTabTargets:
          type: array
          items:
            type: string
          description: |
            Optional list of tab targets to hide in HTML templates that use `data-tab-target` and `data-tab-panel`.
            For example: ["instructions"] hides the Instructions tab/panel.
      additionalProperties: false

    LineItemOverlayDetailRowActionsConfig:
      type: object
      properties:
        viewLabel:
          $ref: '#/components/schemas/LocalizedString'
        editLabel:
          $ref: '#/components/schemas/LocalizedString'
        viewPlacement:
          type: string
          enum: [header, body, hidden]
          description: Where the View action is rendered (defaults to header).
        editPlacement:
          type: string
          enum: [header, body, hidden]
          description: Where the Edit action is rendered (defaults to header).
      additionalProperties: false

    LineItemOverlayRowFilter:
      type: object
      properties:
        includeWhen:
          $ref: '#/components/schemas/WhenClause'
        excludeWhen:
          $ref: '#/components/schemas/WhenClause'
      additionalProperties: false

    LineItemGroupConfigOverride:
      type: object
      description: |
        Optional override for a line-item group's configuration when opening an overlay via a field action.
        Any omitted fields fall back to the base group configuration.
      properties:
        id:
          type: string
        label:
          $ref: '#/components/schemas/LocalizedString'
        ui:
          $ref: '#/components/schemas/LineItemGroupUiConfig'
        minRows:
          type: integer
        maxRows:
          type: integer
        addButtonLabel:
          $ref: '#/components/schemas/LocalizedString'
        anchorFieldId:
          type: string
        addMode:
          type: string
          enum: [overlay, selectorOverlay, inline, auto]
        addOverlay:
          $ref: '#/components/schemas/LineItemAddOverlayConfig'
        sectionSelector:
          $ref: '#/components/schemas/LineItemSelectorConfig'
        dedupRules:
          type: array
          items:
            $ref: '#/components/schemas/LineItemDedupRule'
        totals:
          type: array
          items:
            $ref: '#/components/schemas/LineItemTotalConfig'
        fields:
          type: array
          items:
            $ref: '#/components/schemas/LineItemFieldConfig'
        subGroups:
          type: array
          items:
            $ref: '#/components/schemas/LineItemGroupConfig'
      additionalProperties: false

    LineItemOverlayOpenActionConfig:
      type: object
      description: |
        Field-driven overlay opener configuration.
        When overlay detail is enabled, completing all header fields auto-opens the detail panel (view if available; otherwise edit).
      properties:
        groupId:
          type: string
          description: Target line-item group id to open.
        when:
          $ref: '#/components/schemas/WhenClause'
          description: Optional condition to enable/activate this action.
        label:
          $ref: '#/components/schemas/LocalizedString'
          description: Optional button label override (defaults to the field label).
        rowFilter:
          $ref: '#/components/schemas/LineItemOverlayRowFilter'
          description: Optional row filter applied to the overlay header rows.
        groupOverride:
          $ref: '#/components/schemas/LineItemGroupConfigOverride'
          description: Optional override for the overlay view of this group.
        hideInlineSubgroups:
          type: boolean
          description: When true, hide inline subgroups in the overlay body (header-only + body detail).
        renderMode:
          type: string
          enum: [replace, inline]
          description: |
            Render mode for the field-triggered opener.
            - replace: replace the field control with a button (default)
            - inline: keep the control and show a separate button below
        resetValue:
          $ref: '#/components/schemas/DefaultValue'
          description: |
            Optional value to set on the source field when the trash/reset action is confirmed.
            Use this to revert the field back to its original control by breaking the `when` condition.
        hideTrashIcon:
          type: boolean
          description: |
            When true, hide the trash/reset icon on the overlay opener button.
        hideCloseButton:
          type: boolean
          description: When true, hide the close button in the overlay header.
        closeButtonLabel:
          $ref: '#/components/schemas/LocalizedString'
          description: Optional label override for the overlay close button.
        closeConfirm:
          oneOf:
            - $ref: '#/components/schemas/RowFlowActionConfirmConfig'
            - $ref: '#/components/schemas/OverlayCloseConfirmConfig'
          description: |
            Optional confirm dialog shown when closing the overlay.
            Can be a simple dialog (`RowFlowActionConfirmConfig`) or a conditional multi-case dialog (`OverlayCloseConfirmConfig`).
        flattenFields:
          type: array
          items:
            type: string
          description: |
            Optional list of line-item field ids to render inline in the parent view when the target group only allows one row.
            Requires `maxRows: 1` on the target group (or `groupOverride`) to take effect.
        flattenPlacement:
          type: string
          enum: [left, right, below]
          description: |
            Placement for `flattenFields` relative to the opener field.
            - left: render flattened fields to the left of the opener
            - right: render flattened fields to the right of the opener
            - below: render flattened fields beneath the opener (default)
        rowFlow:
          $ref: '#/components/schemas/RowFlowConfig'
          description: Optional row flow override for the overlay editor opened by this action.
      required: [groupId]
      additionalProperties: false

    RowDisclaimerRule:
      type: object
      required: [text]
      properties:
        when:
          $ref: '#/components/schemas/WhenClause'
          description: Optional condition evaluated against the current row values.
        text:
          $ref: '#/components/schemas/LocalizedString'
          description: Disclaimer text (supports placeholders like {{FIELD_ID}}).

    RowDisclaimerConfig:
      oneOf:
        - $ref: '#/components/schemas/LocalizedString'
        - type: object
          properties:
            template:
              $ref: '#/components/schemas/LocalizedString'
              description: Default disclaimer template (supports placeholders).
            cases:
              type: array
              items:
                $ref: '#/components/schemas/RowDisclaimerRule'
              description: Ordered list of conditional disclaimer rules; first match wins.
            fallback:
              $ref: '#/components/schemas/LocalizedString'
              description: Fallback disclaimer when no cases match and no template is set.

    OptionMapRefConfig:
      type: object
      properties:
        ref:
          type: string
          description: |
            Sheet/tab reference that contains the mapping table.
            Use `REF:TabName` (recommended) or a plain `TabName`.
        keyColumn:
          oneOf:
            - type: integer
              description: 1-based column index (e.g., 1 for column A).
            - type: string
              description: Column letter (e.g., "A") or header label (e.g., "Supplier").
            - type: array
              items:
                oneOf:
                  - type: integer
                    description: 1-based column index (e.g., 1 for column A).
                  - type: string
                    description: Column letter (e.g., "A") or header label (e.g., "Supplier").
              description: |
                Multiple columns used to form a composite key. Values are joined with `||` in the order provided
                (must match `OptionFilter.dependsOn` array order).
          description: Column holding the lookup key (dependency value or composite key).
        lookupColumn:
          oneOf:
            - type: integer
              description: 1-based column index (e.g., 2 for column B).
            - type: string
              description: Column letter (e.g., "B") or header label (e.g., "Allowed options").
          description: Column holding the lookup value(s) (allowed options / derived values).
        delimiter:
          type: string
          description: Optional delimiter to split multiple values stored in one cell (defaults to comma/semicolon/newline splitting).
        splitKey:
          type: boolean
          description: |
            When true, split the key cell into multiple keys (useful when the key column stores a comma-separated list like "Vegan, Vegetarian, No-salt").
            Keys are split using `keyDelimiter` when provided; otherwise the default splitting (comma/semicolon/newline) is used.
            Only applies when `keyColumn` is a single column (not an array).
        keyDelimiter:
          type: string
          description: Optional delimiter to split keys when `splitKey` is true (defaults to comma/semicolon/newline splitting). Use `"none"` to disable splitting.
      required: [ref, keyColumn, lookupColumn]
      example:
        ref: "REF:Supplier_Map"
        keyColumn: Supplier
        lookupColumn: Allowed options

    OptionFilter:
      type: object
      properties:
        dependsOn:
          oneOf:
            - type: string
            - type: array
              items:
                type: string
          description: |
            ID(s) of the field(s) whose value determines allowed options. Accepts a single ID or an ordered array for composite dependencies. When used inside line items, IDs can point to either sibling line-item fields or top-level fields.
        optionMap:
          type: object
          additionalProperties:
            type: array
            items:
              type: string
          description: |
            Mapping of parent value(s) -> allowed options for this field. For multiple dependencies, join values with `||` in the order listed in `dependsOn` (e.g., `"Carrots||Local"`). Use `"*"` as a fallback key.
        optionMapRef:
          $ref: '#/components/schemas/OptionMapRefConfig'
          description: |
            Alternative to `optionMap`: load the mapping from a sheet tab with key/value columns.
            Each row contributes a `key -> value` entry; repeated keys are merged.
        dataSourceField:
          type: string
          description: |
            Column name from a data source row to use for filtering dataSource-backed options.
            The values in this column are compared against the `dependsOn` values.
        dataSourceDelimiter:
          type: string
          description: |
            Optional delimiter for dataSourceField values stored in a single cell (defaults to comma/semicolon/newline splitting).
            Use "none" to disable splitting.
        bypassValues:
          type: array
          items:
            type: string
          description: |
            Optional dependency values that bypass option filtering entirely (returns the full option list).
            If any selected dependency value matches, filtering is skipped.
        matchMode:
          type: string
          enum: [and, or]
          description: |
            How to combine allowed sets when a dependency resolves to multiple values (e.g., multi-select checkbox).
            - and (default): intersect allowed sets (must satisfy all selected values).
            - or: union allowed sets (satisfy any selected value) and record non-matching keys in `__ckNonMatchOptions`.
      required: [dependsOn]
      oneOf:
        - required: [optionMap]
        - required: [optionMapRef]
        - required: [dataSourceField]
      example:
        dependsOn: [Product, Supplier]
        optionMap:
          "Carrots||Local": [Crates]
          Carrots: [Bags, Crates]
          "*": [Bags]

    ValueMapConfig:
      type: object
      properties:
        dependsOn:
          oneOf:
            - type: string
            - type: array
              items:
          type: string
          description: Field ID(s) whose value(s) are used to look up the mapped output (arrays form composite keys joined with `||`).
        optionMap:
          type: object
          additionalProperties:
            type: array
            items:
              type: string
          description: Map of dependency value -> array of strings; arrays are joined with ", " for the readonly TEXT value. Supports `*` fallback.
        optionMapRef:
          $ref: '#/components/schemas/OptionMapRefConfig'
          description: |
            Alternative to `optionMap`: load the mapping from a sheet tab with key/value columns.
            Each row contributes a `key -> value` entry; repeated keys are merged.
      required: [dependsOn]
      oneOf:
        - required: [optionMap]
        - required: [optionMapRef]
      example:
        dependsOn: ING
        optionMap:
          Yogurt: [Milk]
          Pesto: [Milk, Peanuts]
          "*": [None]

    FieldChangeDialogTarget:
      type: object
      properties:
        scope:
          type: string
          enum: [top, row, parent, effect]
          description: |
            Target scope for the dialog input.
            - top: top-level field on the record
            - row: current line-item row
            - parent: parent row (subgroup) or top-level (non-subgroup)
            - effect: selection-effect-created row (requires effectId)
        fieldId:
          type: string
          description: Field id to update on confirm.
        effectId:
          type: string
          description: SelectionEffect.id used to locate the effect-created row(s).
      required: [scope, fieldId]

    FieldChangeDialogInput:
      type: object
      properties:
        id:
          type: string
          description: Unique input id within the dialog.
        label:
          oneOf:
            - type: string
            - $ref: '#/components/schemas/LocalizedString'
          description: Optional label override (defaults to the target field label).
        placeholder:
          oneOf:
            - type: string
            - $ref: '#/components/schemas/LocalizedString'
          description: Optional placeholder for the dialog input.
        type:
          type: string
          enum: [TEXT, PARAGRAPH, NUMBER, CHOICE, CHECKBOX, DATE]
          description: Optional explicit input type (defaults to the target field type).
        required:
          type: boolean
        target:
          $ref: '#/components/schemas/FieldChangeDialogTarget'
      required: [id, target]

    FieldChangeDialogConfig:
      type: object
      properties:
        when:
          $ref: '#/components/schemas/WhenClause'
        title:
          oneOf:
            - type: string
            - $ref: '#/components/schemas/LocalizedString'
        message:
          oneOf:
            - type: string
            - $ref: '#/components/schemas/LocalizedString'
        confirmLabel:
          oneOf:
            - type: string
            - $ref: '#/components/schemas/LocalizedString'
        cancelLabel:
          oneOf:
            - type: string
            - $ref: '#/components/schemas/LocalizedString'
        dedupMode:
          type: string
          enum: [auto, always, never]
          description: |
            Controls the dedup precheck when confirming the change.
            - auto (default): run when the changed field participates in a reject dedup rule
            - always: always run the dedup precheck
            - never: skip the dedup precheck
        inputs:
          type: array
          items:
            $ref: '#/components/schemas/FieldChangeDialogInput'
          description: Optional dialog input fields that update other targets on confirm.
      required: [when]

    DedupDialogConfig:
      type: object
      description: |
        Optional copy overrides for the duplicate-record dialog.

        The dialog message is composed as:
        - `intro` (if provided)
        - a list of dedup key labels + values
        - `outro` (if provided)

        `cancelLabel` is used for list-view cancel actions (when a duplicate is detected before opening the form).
      properties:
        title:
          oneOf:
            - type: string
            - $ref: '#/components/schemas/LocalizedString'
          description: Dialog title shown when a duplicate record is detected.
        intro:
          oneOf:
            - type: string
            - $ref: '#/components/schemas/LocalizedString'
          description: Intro line shown before the list of dedup key values.
        outro:
          oneOf:
            - type: string
            - $ref: '#/components/schemas/LocalizedString'
          description: Outro line shown after the list of dedup key values.
        changeLabel:
          oneOf:
            - type: string
            - $ref: '#/components/schemas/LocalizedString'
          description: Label for the action that clears the dedup fields.
        cancelLabel:
          oneOf:
            - type: string
            - $ref: '#/components/schemas/LocalizedString'
          description: Label for the action that cancels the duplicate dialog (list view).
        openLabel:
          oneOf:
            - type: string
            - $ref: '#/components/schemas/LocalizedString'
          description: Label for the action that opens the existing record.

    DerivedValueConfig:
      oneOf:
        - type: object
          required: [op, dependsOn]
          properties:
            op:
              type: string
              enum: [addDays]
              description: Add (or subtract) days from a base date field.
            dependsOn:
              type: string
              description: ID of the source field to base the calculation on (a DATE value or parseable date string).
            offsetDays:
              type: integer
              description: Number of days to add (can be negative).
            when:
              type: string
              enum: [always, empty]
              description: |
                When to apply the derived value.
                - always: recompute on every change (default for addDays)
                - empty: only set when the target field is empty (allows user overrides)
            hidden:
              type: boolean
              description: Informational flag to mark the field as system-managed/hidden in UI.
          description: Compute a date field automatically (e.g., expiration date = prep date + 2 days).
        - type: object
          required: [op]
          properties:
            op:
              type: string
              enum: [today]
              description: Prefill a DATE field with the current local date (YYYY-MM-DD).
            when:
              type: string
              enum: [always, empty]
              description: |
                When to apply the derived value.
                - empty: default for today (prefill behavior)
                - always: recompute on every change
            hidden:
              type: boolean
              description: Informational flag to mark the field as system-managed/hidden in UI.
          description: Prefill a DATE field with today’s date (local time).
        - type: object
          required: [op, dependsOn]
          properties:
            op:
              type: string
              enum: [copy]
              description: Copy the value from another field (useful for numeric defaults).
            dependsOn:
              type: string
              description: ID of the source field whose value should be copied into the target.
            applyOn:
              type: string
              enum: [change, blur]
              description: |
                When to apply the derived value during editing.
                - blur: default for copy (avoids mid-typing updates; applies when the user leaves the field)
                - change: apply on every keystroke/change
            when:
              type: string
              enum: [always, empty]
              description: |
                When to apply the derived value.
                - empty: default for copy (behaves like a default; allows user overrides)
                - always: keep the target in sync with the source field
            copyMode:
              type: string
              enum: [replace, allowIncrease, allowDecrease]
              description: |
                Optional copy mode for numeric values (only applies when `when: "always"`):
                - replace: direct copy (default)
                - allowIncrease: user can increase above source, but never below it (clamps to source on blur)
                - allowDecrease: user can decrease below source, but never above it (clamps to source on blur)
            hidden:
              type: boolean
              description: Informational flag to mark the field as system-managed/hidden in UI.
          description: Copy a field value from another field (typically for NUMBER defaults).
        - type: object
          required: [op, expression]
          properties:
            op:
              type: string
              enum: [calc]
              description: Compute a numeric expression using fields and line-item aggregates.
            expression:
              type: string
              description: |
                Numeric expression using `{FIELD_ID}` tokens and `SUM(GROUP.FIELD)` aggregates.
                Example: "{QTY} - SUM(MP_TYPE_LI.PREP_QTY)".
            lineItemFilters:
              type: array
              description: Optional filters applied to specific SUM(...) aggregates.
              items:
                type: object
                required: [ref, when]
                properties:
                  ref:
                    type: string
                    description: Aggregate reference matching the SUM(...) token (e.g., "MP_TYPE_LI.PREP_QTY").
                  when:
                    $ref: '#/components/schemas/WhenClause'
                    description: Row-level filter applied to aggregate rows.
            applyOn:
              type: string
              enum: [change, blur]
              description: |
                When to apply the derived value during editing.
                - change: apply on every onChange (default for calc)
                - blur: apply only after the user leaves the input
            when:
              type: string
              enum: [always, empty]
              description: |
                When to apply the derived value.
                - always: recompute on every change (default for calc)
                - empty: only set when the target field is empty (allows user overrides)
            precision:
              type: integer
              description: Optional decimal precision to round to.
            min:
              type: number
              description: Optional minimum clamp for the computed result.
            max:
              type: number
              description: Optional maximum clamp for the computed result.
            hidden:
              type: boolean
              description: Informational flag to mark the field as system-managed/hidden in UI.
          description: Compute numeric fields from other fields and line-item aggregates.
        - type: object
          required: [op, thresholds]
          properties:
            op:
              type: string
              enum: [timeOfDayMap]
              description: Map the current time-of-day (or a source date/time field) into a target value using thresholds.
            dependsOn:
              type: string
              description: Optional source field ID used to read a date/time value. When omitted, current time ("now") is used.
            thresholds:
              type: array
              description: |
                Threshold mapping evaluated in ascending order: the first entry where current time-of-day < before wins.
                The last entry may omit `before` to act as the fallback.
              items:
                type: object
                properties:
                  before:
                    oneOf:
                      - type: string
                        description: Threshold time (local) such as "10h", "12:30".
                      - type: integer
                        description: Threshold hour (e.g., 10 means 10h; values > 24 are treated as minutes since midnight).
                  value:
                    type: string
                    description: Value to set on the target field when the threshold matches.
                required: [value]
            when:
              type: string
              enum: [always, empty]
              description: |
                When to apply the derived value.
                - empty: default for timeOfDayMap (prefill/default behavior)
                - always: recompute on every change
            hidden:
              type: boolean
              description: Informational flag to mark the field as system-managed/hidden in UI.
          description: Map time-of-day to a value (e.g., auto-select SHIFT or a status label).

    DataSourceConfig:
      type: object
      properties:
        id:
          type: string
          description: Identifier to look up a backend data source (passed to Apps Script `fetchDataSource`).
        ref:
          type: string
          description: Optional reference key to disambiguate multiple sources.
        mode:
          type: string
          enum: [options, prefill, list]
          description: Whether the source populates options, prefills values/line items, or serves list views.
        sheetId:
          type: string
          description: Optional sheet id when sourcing from another spreadsheet file.
        tabName:
          type: string
          description: Tab name for the source table.
        localeKey:
          type: string
          description: Optional column used to scope localized rows.
        statusAllowList:
          oneOf:
            - type: string
              description: Comma-separated list of allowed status values (e.g., "Active, In progress").
            - type: array
              items:
                type: string
          description: |
            Optional allow-list for **record-like** data sources that include a `status` column.

            When set, only rows whose `status` value matches one of these strings (case-insensitive) are returned.
        limit:
          type: integer
          description: Optional max rows to read (default 50; hard cap 200).
        projection:
          type: array
          items:
            type: string
          description: |
            Limit columns returned from the data source.

            Recommended convention for source tabs: `Label [KEY]` headers (e.g., `Supplier [SUPPLIER]`, `Email [EMAIL]`).
            `projection` entries can reference either the raw header text or the bracket key.
        mapping:
          type: object
          additionalProperties:
            type: string
          description: |
            Optional map from source column -> target field id (used for prefill/line-item injection).

            Source column keys can reference either the raw header text or a bracket key when the source header uses `Label [KEY]`.
        tooltipField:
          type: string
          description: Optional column name to surface as tooltip text for each option (shown in form + summary).
        tooltipLabel:
          $ref: '#/components/schemas/LocalizedString'
          description: |
            Optional localized label/title to show on the tooltip trigger and overlay header for fields using this data source.
      required: [id]
      example:
        id: recipes
        sheetId: 1AbcDEF_sheet_id_here
        tabName: Recipes Data
        projection: [name_en, ingredient, quantity, unit]
        localeKey: locale
        limit: 100
        mode: prefill
        mapping:
          ingredient: ingredient
          quantity: qty
          unit: unit

    DashboardConfig:
      type: object
      description: JSON stored in the dashboard’s “Follow-up Config (JSON)” column.
      properties:
        listView:
          $ref: '#/components/schemas/ListViewConfig'
          description: |
            Standard list view configuration for this form (**recommended**).

            Use this to control the List screen:
            - `title`: heading shown above the table (defaults to "Records")
            - `columns`: optional dashboard-defined columns (prepended before any questions with `listView: true`)
              - Supports computed/action columns via `type: "rule"`
            - `metaColumns`: optional system columns appended after question columns (`createdAt`, `updatedAt`, `status`, `pdfUrl`)
            - `legend`: optional legend shown below the table to explain icons / table elements (only shown when defined)
            - `defaultSort`: initial sort field/direction
            - `pageSize`: rows per page (default 10, max 50)

            Notes:
            - The List screen appears when at least one question is marked `listView: true` or when you provide `columns`.
            - Legacy top-level aliases (`listViewMetaColumns`, `listViewColumns`, `listViewLegend`) are still accepted but deprecated.
        appHeader:
          $ref: '#/components/schemas/AppHeaderConfig'
          description: Optional app header branding (logo shown next to the title).
        groupBehavior:
          $ref: '#/components/schemas/GroupBehaviorConfig'
          description: |
            Optional behavior for collapsible group sections in the Edit view:
            - auto-collapse completed sections
            - optionally open the next incomplete section
            - optionally auto-scroll expanded sections into view
        submitValidation:
          $ref: '#/components/schemas/SubmitValidationConfig'
          description: |
            Optional submission validation UI settings:
            - enforce ordered entry for required fields
            - disable Submit until the form is valid
            - customize the top error banner message (per language)
        steps:
          $ref: '#/components/schemas/StepsConfig'
          description: |
            Optional **guided steps** configuration for the React Edit (form) view.

            When set with `mode: "guided"`, the app renders a multi-step guided UI:
            - a stepper at the top of the edit experience
            - step-scoped progressive disclosure (only show fields relevant to the active step)
            - configurable forward gating + automatic advancement (default: `whenValid` + `onValid`)

            Notes:
            - Steps can mix top-level questions and line item groups.
            - Step state is exposed via virtual fields like `__ckStepValid_<stepId>` so existing `visibility` rules can gate buttons/fields.
        portraitOnly:
          type: boolean
          description: |
            Optional UI setting for the web app: when true, **block landscape orientation** with a “rotate to portrait” message.

            Notes:
            - Browsers cannot reliably lock orientation (especially on iOS Safari). This is a UI guardrail, not a hard lock.
            - Intended for phone-sized screens to avoid awkward “landscape compact” layouts.
        submissionConfirmationTitle:
          $ref: '#/components/schemas/LocalizedString'
          description: |
            Optional confirmation title shown **before** submitting (per language).

            When the user taps **Submit**, the app shows a Confirm/Cancel overlay. This text is the title shown in that overlay.
            When omitted, the UI falls back to localized system strings.
        submissionConfirmationMessage:
          $ref: '#/components/schemas/LocalizedString'
          description: |
            Optional confirmation message shown **before** submitting (per language).

            When the user taps **Submit**, the app shows a Confirm/Cancel overlay. This text is the body message shown in that overlay.
            When omitted, the UI falls back to localized system strings.

            Placeholders:
            - You can include `{FIELD_ID}` (or `{{FIELD_ID}}`) and the UI will substitute the current record’s values.
            - `{field}` is reserved for required-field messages; prefer `{FIELD_ID}` for record values.
        submissionConfirmationConfirmLabel:
          $ref: '#/components/schemas/LocalizedString'
          description: |
            Optional localized label for the **positive (confirm)** button in the submission confirmation dialog.

            When omitted, the UI falls back to the resolved Submit button label.
        submissionConfirmationCancelLabel:
          $ref: '#/components/schemas/LocalizedString'
          description: |
            Optional localized label for the **negative (cancel)** button in the submission confirmation dialog.

            When omitted, the UI falls back to localized system strings (e.g. "Cancel").
        dedupDialog:
          $ref: '#/components/schemas/DedupDialogConfig'
          description: |
            Optional copy overrides for the **duplicate record** dialog.

            The dialog message automatically lists the dedup key labels + values between `intro` and `outro`.
        submitButtonLabel:
          $ref: '#/components/schemas/LocalizedString'
          description: |
            Optional localized label override for the **Submit** button in the React web app.

            When omitted, the UI uses the default localized system label.
        summaryButtonLabel:
          $ref: '#/components/schemas/LocalizedString'
          description: |
            Optional localized label override for the **Summary** button in the React web app.

            Example: { "en": "Checklist", "fr": "Liste", "nl": "Checklist" }
        languages:
          type: array
          description: |
            Enabled UI languages for the web app (max 3). Supported: `EN`, `FR`, `NL`.

            - When omitted, languages are auto-detected from which label columns have values.
            - You can also provide a comma-separated string (e.g. `"EN,FR"`).
          items:
            type: string
            enum: [EN, FR, NL]
        disabledLanguages:
          type: array
          description: Optional list of languages to disable (removed from `languages`).
          items:
            type: string
            enum: [EN, FR, NL]
        defaultLanguage:
          type: string
          description: Default language for the web app (and the forced language when language selection is disabled).
          enum: [EN, FR, NL]
        languageSelectorEnabled:
          type: boolean
          description: |
            Enable/disable language selection in the web app.

            - When `false`, the language selector is hidden and the app always uses `defaultLanguage`.
            - When `true` (default), users can switch language (if 2+ languages are enabled).
        pdfTemplateId:
          $ref: '#/components/schemas/TemplateIdMap'
          description: |
            Google Doc template id(s) used to render follow-up PDFs (Create PDF / Send Email w/ PDF attachment).

            Notes:
            - Generated rows inside `GROUP_TABLE` and `CONSOLIDATED_TABLE` outputs use alternating row background colors (zebra striping) automatically.
        pdfFolderId:
          type: string
        pdfFileNameFieldId:
          type: string
          description: |
            Optional field id used to name generated PDFs (and email attachments).
            Can reference a question id or a meta field: `id`, `createdAt`, `updatedAt`, `status`, `pdfUrl`.
        emailTemplateId:
          $ref: '#/components/schemas/TemplateIdMap'
        emailSubject:
          $ref: '#/components/schemas/LocalizedString'
        emailRecipients:
          type: array
          items:
            $ref: '#/components/schemas/EmailRecipientEntry'
        emailCc:
          type: array
          items:
            $ref: '#/components/schemas/EmailRecipientEntry'
        emailBcc:
          type: array
          items:
            $ref: '#/components/schemas/EmailRecipientEntry'
        statusFieldId:
          type: string
        statusTransitions:
          $ref: '#/components/schemas/FollowupStatusConfig'
          description: |
            Optional status values used by follow-up actions and status-aware UI.

            Keys:
            - `inProgress`: value for draft/in-progress records (used by autosave/list view defaults).
            - `reOpened`: value written when explicitly re-opening a closed record.
            - `onPdf`, `onEmail`, `onClose`: values written when follow-up actions complete.
            - Values can be localized objects (per language).
        listViewMetaColumns:
          deprecated: true
          type: array
          description: Deprecated. Use `listView.metaColumns`.
          items:
            type: string
            enum: [createdAt, updatedAt, status, pdfUrl]
        listViewColumns:
          deprecated: true
          type: array
          description: Deprecated. Use `listView.columns`.
          items:
            $ref: '#/components/schemas/ListViewColumnConfig'
        listViewLegend:
          deprecated: true
          type: array
          description: Deprecated. Use `listView.legend`.
          items:
            $ref: '#/components/schemas/ListViewLegendItem'
        autoSave:
          type: object
          description: |
            Optional draft autosave behavior for the React edit view.

            - Saves in the background after a debounce when form values change.
            - No validation is required for draft saves.
            - Writes Status to `autoSave.status` or `statusTransitions.inProgress` (unless the record matches `statusTransitions.onClose`).
            - Shows a one-time autosave explainer overlay in the Create/Edit/Copy view (customize copy in `autosaveNotice.*` system strings).
          properties:
            enabled:
              type: boolean
              description: Enable draft autosave.
            debounceMs:
              type: number
              description: Debounce interval (ms) before sending a background save. Default 2000.
            status:
              type: string
              description: Status value written during autosave. Defaults to `statusTransitions.inProgress` (or "In progress").
        summaryViewEnabled:
          type: boolean
          description: |
            Enable the React Summary view for this form.

            - When `true` (default), clicking a record whose status matches `statusTransitions.onClose` opens the Summary view.
            - When `false`, list-row clicks always open the **Edit** view (onClose records are read-only).
        summaryHtmlTemplateId:
          $ref: '#/components/schemas/TemplateIdMap'
          description: |
            Optional HTML template to fully replace the built-in Summary view UI.

            - When set, the Summary view renders this HTML template (Drive file) with placeholders.
            - Line-item templates also expose system pseudo-fields `{{GROUP.__ROWINDEX}}` and `{{GROUP.__ROWID}}` in row contexts.
            - If rendering fails, the app falls back to the built-in Summary view.
        templateCacheTtlSeconds:
          type: number
          description: |
            CacheService TTL (seconds) used when caching **HTML and Markdown templates** for this form.

            Notes:
            - Apps Script CacheService has a hard max TTL of **6 hours** (21600 seconds).
            - When omitted (recommended) or set to `0`/negative, the app uses the maximum TTL and relies on the template cache epoch
              (flushed automatically by **Create/Update All Forms**) to refresh templates immediately when you update Drive files.
            - When set, values are clamped to `[30, 21600]`.
        copyCurrentRecordEnabled:
          type: boolean
          description: |
            Enable the "Copy current record" action in the Create menu.

            - When `true` (default), Create opens a menu: New record / Copy current record.
            - When `false`, Create always starts a New record (no copy option).
        copyCurrentRecordDropFields:
          type: array
          items:
            type: string
          description: |
            Optional list of **field ids** to clear when the user copies the current record.

            This forces users to re-enter specific fields on the new record (useful for fields like DATE, SHIFT, etc.).

            Notes:
            - These are **question ids** (top-level fields).
            - When omitted or empty, copying preserves all fields (except system/meta fields like id/createdAt/updatedAt).
        createButtonLabel:
          $ref: '#/components/schemas/LocalizedString'
          description: |
            Optional localized label override for the **Create** button in the web app.
            Also used as the label for the "New record" action in the Create menu.
        copyCurrentRecordLabel:
          $ref: '#/components/schemas/LocalizedString'
          description: |
            Optional localized label override for the **Copy current record** action in the web app.
        createNewRecordEnabled:
          type: boolean
          description: |
            Enable/disable the standard "New record" action in the Create menu.

            - When `true` (default), users can start a blank New record from the Create button/menu.
            - When `false`, the "New record" entry is hidden and the Create button will not start a blank record.
              Use `createRecordPreset` buttons for record creation.
        createRecordPresetButtonsEnabled:
          type: boolean
          description: |
            Enable/disable `createRecordPreset` custom BUTTON actions in the web app.

            - When `true` (default), preset buttons work normally.
            - When `false`, preset buttons are ignored and **will not show** in any action bars/menus.
        actionBars:
          $ref: '#/components/schemas/ActionBarsConfig'
          description: |
            Optional per-view configuration for the top and bottom action bars (system + custom buttons).
            When omitted, the app uses the default layout.
      additionalProperties: true

    AppHeaderConfig:
      type: object
      description: App header branding (logo shown in the top sticky header and drawer).
      properties:
        logo:
          type: string
          description: |
            Optional logo image shown in the app header.

            Accepts:
            - A Google Drive file id (e.g., `"1AbcDEF...xyz"`)
            - A Google Drive share URL (e.g., `"https://drive.google.com/file/d/<ID>/view?..."`)
            - A direct `https://...` image URL

            The app will normalize Drive links into a direct-view URL.
      additionalProperties: false

    GroupBehaviorConfig:
      type: object
      description: Behavior for collapsible group sections in the Edit (form) view and Summary view.
      properties:
        autoCollapseOnComplete:
          type: boolean
          description: When true, automatically collapse a section when it becomes complete (based on required progress).
        autoOpenNextIncomplete:
          type: boolean
          description: When true, after auto-collapsing a completed section, automatically open the next incomplete section.
        autoScrollOnExpand:
          type: boolean
          description: When true, scroll an expanded section into view (below the sticky header). Default is true when `autoCollapseOnComplete` is enabled.
        summaryExpandAll:
          type: boolean
          description: When true, keep collapsible group sections expanded in the Summary view (native React summary).
      additionalProperties: false

    SubmitValidationConfig:
      type: object
      description: Submission validation UI settings.
      properties:
        enforceFieldOrder:
          type: boolean
          description: When true, require users to complete required fields in order and disable Submit until the form is valid.
        submitTopErrorMessage:
          $ref: '#/components/schemas/LocalizedString'
          description: Optional localized override for the top submit validation error banner.
        lineItemGroupNeedsAttentionMessage:
          $ref: '#/components/schemas/LocalizedString'
          description: Optional localized override for the "Needs attention" helper shown under line-item group pills.
      additionalProperties: false

    StepsConfig:
      type: object
      description: |
        Guided multi-step Edit (form) mode configuration.

        When enabled, the React web app renders:
        - a stepper at the top of the edit view
        - step-scoped progressive disclosure (only show fields relevant to the active step)
        - configurable forward gating + auto-advance (defaults: `whenValid` + `onValid`)
        - inline field-level validation feedback when a step is blocked (no step-level banner)
      properties:
        mode:
          type: string
          enum: [guided]
          description: Enable guided steps mode for this form.
        stateFields:
          type: object
          description: Optional configuration for virtual/computed step fields.
          properties:
            prefix:
              type: string
              description: Prefix for virtual step fields. Default `__ckStep`.
          additionalProperties: false
        defaultForwardGate:
          type: string
          enum: [free, whenComplete, whenValid]
          description: Default forward navigation gate for all steps.
        defaultAutoAdvance:
          type: string
          enum: [off, onComplete, onValid]
          description: Default auto-advance behavior for all steps.
        stepSubmitLabel:
          $ref: '#/components/schemas/LocalizedString'
          description: Optional label for the primary action while navigating between steps (non-final steps).
        backButtonLabel:
          $ref: '#/components/schemas/LocalizedString'
          description: Optional Back button label for guided steps.
        showBackButton:
          type: boolean
          description: Global toggle for showing the Back button in guided steps (default true).
        header:
          $ref: '#/components/schemas/StepsHeaderConfig'
        items:
          type: array
          minItems: 1
          items:
            $ref: '#/components/schemas/StepConfig'
      required: [mode, items]
      additionalProperties: true

    StepsHeaderConfig:
      type: object
      description: Optional targets rendered above step content (e.g., customer/date/service).
      properties:
        include:
          type: array
          items:
            $ref: '#/components/schemas/StepTargetConfig'
      additionalProperties: false

    StepConfig:
      type: object
      description: Single step in guided mode.
      properties:
        id:
          type: string
        label:
          $ref: '#/components/schemas/LocalizedString'
        helpText:
          $ref: '#/components/schemas/LocalizedString'
          description: |
            Optional helper text displayed above the step content (guided mode).
            Use this for step-wide guidance such as food safety confirmations or photo requirements.
        render:
          $ref: '#/components/schemas/StepsRenderDefaultsConfig'
        include:
          type: array
          minItems: 1
          items:
            $ref: '#/components/schemas/StepTargetConfig'
        navigation:
          $ref: '#/components/schemas/StepNavigationConfig'
      required: [id, include]
      additionalProperties: true

    StepsRenderDefaultsConfig:
      type: object
      description: Per-step default rendering for line groups and subgroups.
      properties:
        lineGroups:
          type: object
          properties:
            mode:
              type: string
              enum: [inline, overlay]
          additionalProperties: false
        subGroups:
          type: object
          properties:
            mode:
              type: string
              enum: [inline, overlay]
          additionalProperties: false
      additionalProperties: false

    StepNavigationConfig:
      type: object
      description: Optional gating + auto-advance behavior for a step.
      properties:
        forwardGate:
          type: string
          enum: [free, whenComplete, whenValid]
        autoAdvance:
          type: string
          enum: [off, onComplete, onValid]
        allowBack:
          type: boolean
          description: When true (default), users can navigate back to previous steps.
        submitLabel:
          $ref: '#/components/schemas/LocalizedString'
          description: Optional label override for the primary action while this step is active (non-final steps).
        backLabel:
          $ref: '#/components/schemas/LocalizedString'
          description: Optional label override for the Back button on this step.
        showBackButton:
          type: boolean
          description: Optional per-step toggle to hide/show the Back button (defaults to the global setting).
      additionalProperties: false

    StepRowFilterConfig:
      type: object
      description: |
        Row filtering for line item groups/subgroups in a step.
        Filtering affects rendering and step evaluation scope; it does not delete stored rows.
      properties:
        includeWhen:
          $ref: '#/components/schemas/WhenClause'
        excludeWhen:
          $ref: '#/components/schemas/WhenClause'
      additionalProperties: false

    RowFlowConfig:
      type: object
      description: Step-scoped progressive row flow configuration for line groups.
      properties:
        mode:
          type: string
          enum: [progressive]
        references:
          type: object
          description: Map of reference ids to child line item groups.
          additionalProperties:
            $ref: '#/components/schemas/RowFlowReferenceConfig'
        output:
          $ref: '#/components/schemas/RowFlowOutputConfig'
        prompts:
          type: array
          items:
            $ref: '#/components/schemas/RowFlowPromptConfig'
        actions:
          type: array
          items:
            $ref: '#/components/schemas/RowFlowActionConfig'
        overlayContextHeader:
          $ref: '#/components/schemas/RowFlowOverlayContextHeaderConfig'
      additionalProperties: false

    RowFlowReferenceConfig:
      type: object
      properties:
        groupId:
          type: string
          description: Target line item group id.
        parentRef:
          type: string
          description: Optional parent reference id (for nested subgroups).
        match:
          type: string
          enum: [first, any, all]
          description: Row matching strategy when multiple rows are present.
        rowFilter:
          $ref: '#/components/schemas/StepRowFilterConfig'
      required: [groupId]
      additionalProperties: false

    RowFlowOverlayContextHeaderConfig:
      type: object
      properties:
        fields:
          type: array
          items:
            $ref: '#/components/schemas/RowFlowOverlayContextFieldConfig'
      required: [fields]
      additionalProperties: false

    RowFlowOverlayContextFieldConfig:
      type: object
      properties:
        fieldRef:
          type: string
          description: Parent field id or reference field (e.g., "childRef.RECIPE").
        label:
          $ref: '#/components/schemas/LocalizedString'
          description: |
            Optional label or template for this value. If the label contains `{{value}}`,
            it will be replaced with the resolved value (e.g., "Leftovers for: {{value}}").
      required: [fieldRef]
      additionalProperties: false

    RowFlowOutputConfig:
      type: object
      properties:
        separator:
          type: string
          description: Output separator between segments (default " | ").
        hideEmpty:
          type: boolean
          description: When true, empty segments are omitted from the output row.
        segments:
          type: array
          items:
            $ref: '#/components/schemas/RowFlowOutputSegmentConfig'
        actions:
          type: array
          items:
            $ref: '#/components/schemas/RowFlowActionRef'
        actionsLayout:
          type: string
          enum: [inline, below]
          description: |
            Layout for output actions relative to the segments.
            - inline: render actions on the same row (default)
            - below: render actions on a separate row
        actionsScope:
          type: string
          enum: [row, group]
          description: |
            Scope for output actions.
            - row: render actions per row (default)
            - group: render actions once after all rows
      additionalProperties: false

    RowFlowOutputSegmentFormatConfig:
      type: object
      properties:
        type:
          type: string
          enum: [text, list]
        listDelimiter:
          type: string
      additionalProperties: false

    RowFlowOutputSegmentConfig:
      type: object
      properties:
        fieldRef:
          type: string
          description: Parent field id or reference field (e.g., "childRef.RECIPE").
        label:
          $ref: '#/components/schemas/LocalizedString'
        showWhen:
          $ref: '#/components/schemas/WhenClause'
        format:
          $ref: '#/components/schemas/RowFlowOutputSegmentFormatConfig'
        renderAs:
          type: string
          enum: [value, control]
        editAction:
          type: string
          description: Action id to render as an edit icon next to this segment.
        editActions:
          type: array
          items:
            type: string
          description: Action ids to render as icons next to this segment (renders alongside editAction when provided).
      required: [fieldRef]
      additionalProperties: false

    RowFlowPromptInputConfig:
      type: object
      properties:
        kind:
          type: string
          enum: [field, selectorOverlay]
        targetRef:
          type: string
          description: Reference id for selector overlay prompts.
        groupOverride:
          $ref: '#/components/schemas/LineItemGroupConfigOverride'
          description: Optional line-item group override applied for selector overlay prompts.
        label:
          $ref: '#/components/schemas/LocalizedString'
        labelLayout:
          type: string
          enum: [stacked, inline, hidden]
          description: |
            Prompt label layout for field inputs.
            - stacked: label above the control (default)
            - inline: label rendered inline with the control
            - hidden: hide the visual label (screen-reader label is preserved)
        placeholder:
          $ref: '#/components/schemas/LocalizedString'
        helperText:
          $ref: '#/components/schemas/LocalizedString'
      additionalProperties: false

    RowFlowPromptConfig:
      type: object
      properties:
        id:
          type: string
        fieldRef:
          type: string
          description: Field id or reference field id for the prompt.
        input:
          $ref: '#/components/schemas/RowFlowPromptInputConfig'
        showWhen:
          $ref: '#/components/schemas/WhenClause'
        completedWhen:
          $ref: '#/components/schemas/WhenClause'
        hideWhenFilled:
          type: boolean
        keepVisibleWhenFilled:
          type: boolean
        onCompleteActions:
          type: array
          items:
            type: string
          description: |
            Action ids to trigger once when the prompt transitions to complete.
            Useful for auto-opening overlays after a selection.
        actionsLayout:
          type: string
          enum: [below, inline]
          description: |
            Layout for prompt actions relative to the input control.
            - below: render actions on a separate row (default)
            - inline: render actions alongside the prompt control
        actions:
          type: array
          items:
            $ref: '#/components/schemas/RowFlowActionRef'
      required: [id]
      additionalProperties: false

    RowFlowActionRef:
      type: object
      properties:
        id:
          type: string
        position:
          type: string
          enum: [start, end]
        scope:
          type: string
          enum: [row, group]
        showWhen:
          $ref: '#/components/schemas/WhenClause'
      required: [id]
      additionalProperties: false

    RowFlowActionConfirmConfig:
      type: object
      properties:
        title:
          $ref: '#/components/schemas/LocalizedString'
        body:
          $ref: '#/components/schemas/LocalizedString'
        confirmLabel:
          $ref: '#/components/schemas/LocalizedString'
        cancelLabel:
          $ref: '#/components/schemas/LocalizedString'
        showCancel:
          type: boolean
        kind:
          type: string
        timing:
          type: string
          enum: [before, after]
          description: When to show the dialog relative to the action. `before` opens first (default); `after` opens after the action completes.
      additionalProperties: false

    OverlayCloseConfirmCaseConfig:
      type: object
      description: |
        Conditional close-confirm case for full-page overlays.

        When a case matches, the dialog opens and the user can either continue editing (cancel) or exit (confirm).
        When confirmed, optional `onConfirmEffects` can run (for example, delete incomplete line-item rows before leaving).
      properties:
        when:
          $ref: '#/components/schemas/WhenClause'
          description: Optional condition controlling when this case applies (first match wins).
        title:
          $ref: '#/components/schemas/LocalizedString'
        body:
          $ref: '#/components/schemas/LocalizedString'
        confirmLabel:
          $ref: '#/components/schemas/LocalizedString'
        cancelLabel:
          $ref: '#/components/schemas/LocalizedString'
        showCancel:
          type: boolean
        kind:
          type: string
        timing:
          type: string
          enum: [before, after]
        onConfirmEffects:
          type: array
          items:
            $ref: '#/components/schemas/RowFlowActionEffectConfig'
          description: Optional effects to run after the user confirms exit.
        highlightFirstError:
          type: boolean
          description: When true, dialog copy may include a hint about the first validation error (if any).
        validateOnReopen:
          type: boolean
          description: When true, re-run validation and focus the first issue the next time this overlay opens.
      additionalProperties: false

    OverlayCloseConfirmConfig:
      type: object
      description: |
        Overlay close confirmation with conditional cases.

        This is used for full-page line-item overlays (and overlayDetail edit panels) to allow exiting even when invalid,
        while still giving users a choice and optionally discarding incomplete rows on exit.
      properties:
        cases:
          type: array
          items:
            $ref: '#/components/schemas/OverlayCloseConfirmCaseConfig'
          description: Ordered list of cases; first matching `when` wins.
        default:
          $ref: '#/components/schemas/RowFlowActionConfirmConfig'
          description: Optional fallback confirm config when no case matches.
        defaultOnConfirmEffects:
          type: array
          items:
            $ref: '#/components/schemas/RowFlowActionEffectConfig'
          description: Optional effects to run when `default` is confirmed.
        allowCloseFromEdit:
          type: boolean
          description: |
            When true, allow the close button to attempt to close the overlay directly from overlayDetail edit mode
            (instead of switching to view mode first when a view template exists).
      required: [cases]
      additionalProperties: false

    RowFlowActionEffectConfig:
      oneOf:
        - type: object
          properties:
            type:
              type: string
              enum: [setValue]
            fieldRef:
              type: string
            value:
              $ref: '#/components/schemas/DefaultValue'
          required: [type, fieldRef]
          additionalProperties: false
        - type: object
          properties:
            type:
              type: string
              enum: [deleteLineItems]
            targetRef:
              type: string
            groupId:
              type: string
            rowFilter:
              $ref: '#/components/schemas/StepRowFilterConfig'
          required: [type]
          additionalProperties: false
        - type: object
          properties:
            type:
              type: string
              enum: [deleteRow]
          required: [type]
          additionalProperties: false
        - type: object
          properties:
            type:
              type: string
              enum: [addLineItems]
            targetRef:
              type: string
            groupId:
              type: string
            preset:
              type: object
              description: Optional field/value map for new rows.
            count:
              type: integer
              description: Number of rows to add (default 1).
          required: [type]
          additionalProperties: false
        - type: object
          properties:
            type:
              type: string
              enum: [closeOverlay]
          required: [type]
          additionalProperties: false
        - type: object
          properties:
            type:
              type: string
              enum: [openOverlay]
            targetRef:
              type: string
            groupId:
              type: string
            when:
              $ref: '#/components/schemas/WhenClause'
            rowFilter:
              $ref: '#/components/schemas/StepRowFilterConfig'
            label:
              $ref: '#/components/schemas/LocalizedString'
            groupOverride:
              $ref: '#/components/schemas/LineItemGroupConfigOverride'
            hideInlineSubgroups:
              type: boolean
            renderMode:
              type: string
              enum: [replace, inline]
            resetValue:
              $ref: '#/components/schemas/DefaultValue'
            hideTrashIcon:
              type: boolean
            hideCloseButton:
              type: boolean
            closeButtonLabel:
              $ref: '#/components/schemas/LocalizedString'
            closeConfirm:
              oneOf:
                - $ref: '#/components/schemas/RowFlowActionConfirmConfig'
                - $ref: '#/components/schemas/OverlayCloseConfirmConfig'
            flattenFields:
              type: array
              items:
                type: string
            flattenPlacement:
              type: string
              enum: [left, right, below]
            rowFlow:
              $ref: '#/components/schemas/RowFlowConfig'
            overlayContextHeader:
              $ref: '#/components/schemas/RowFlowOverlayContextHeaderConfig'
            overlayHelperText:
              $ref: '#/components/schemas/RowFlowOverlayContextHeaderConfig'
          required: [type]
          additionalProperties: false

    RowFlowActionConfig:
      type: object
      properties:
        id:
          type: string
        label:
          $ref: '#/components/schemas/LocalizedString'
        icon:
          type: string
          enum: [edit, remove, add, back]
        variant:
          type: string
          enum: [button, icon]
        tone:
          type: string
          enum: [primary, secondary]
        showWhen:
          $ref: '#/components/schemas/WhenClause'
        confirm:
          $ref: '#/components/schemas/RowFlowActionConfirmConfig'
        effects:
          type: array
          items:
            $ref: '#/components/schemas/RowFlowActionEffectConfig'
      required: [id]
      additionalProperties: false

    StepSubGroupTargetConfig:
      type: object
      description: Subgroup scoping within a step.
      properties:
        id:
          type: string
          description: Subgroup id (stable identifier).
        fields:
          type: array
          items:
            oneOf:
              - type: string
              - type: object
                properties:
                  id:
                    type: string
                    description: Subgroup field id.
                  renderAsLabel:
                    type: boolean
                    description: When true, render this subgroup field value as a read-only label in this step (guided edit mode).
                required: [id]
                additionalProperties: false
          description: |
            Allowlist of visible subgroup row field ids for this step.

            You can provide either:
            - A string field id: `"ING"`
            - Or an object `{ id, renderAsLabel }` to make a field step-scoped read-only:
              `{ "id": "ING", "renderAsLabel": true }`
        rows:
          $ref: '#/components/schemas/StepRowFilterConfig'
        validationRows:
          $ref: '#/components/schemas/StepRowFilterConfig'
          description: |
            Optional row filter used ONLY for guided-step validation/status (not rendering).
            This lets a step display rows differently than it validates them (e.g. show all rows, but only validate rows where QTY > 0).
            If omitted, `rows` is used for both rendering and validation.
        readOnlyFields:
          type: array
          description: Optional list of subgroup field ids to render as read-only labels in guided steps.
          items:
            type: string
        displayMode:
          type: string
          enum: [inline, overlay, inherit]
      required: [id]
      additionalProperties: true

    StepSubGroupCollectionConfig:
      type: object
      description: Optional subgroup allowlist + default rendering behavior for a line group in a step.
      properties:
        displayMode:
          type: string
          enum: [inline, overlay, inherit]
        include:
          type: array
          items:
            $ref: '#/components/schemas/StepSubGroupTargetConfig'
      additionalProperties: true

    StepQuestionTargetConfig:
      type: object
      properties:
        kind:
          type: string
          enum: [question]
        id:
          type: string
        renderAsLabel:
          type: boolean
          description: When true, render the question value as a read-only label in this step (guided edit mode).
      required: [kind, id]
      additionalProperties: false

    StepLineGroupTargetConfig:
      type: object
      properties:
        kind:
          type: string
          enum: [lineGroup]
        id:
          type: string
          description: Line item group question id.
        presentation:
          type: string
          enum: [groupEditor, liftedRowFields]
          description: |
            How this line group should be rendered inside the step.
            - groupEditor: use the existing line item group editor UI
            - liftedRowFields: show selected nested row fields as top-level step content
        rowFlow:
          $ref: '#/components/schemas/RowFlowConfig'
          description: Optional step-scoped row flow configuration for progressive input/output per row.
        fields:
          type: array
          items:
            oneOf:
              - type: string
              - type: object
                properties:
                  id:
                    type: string
                    description: Parent row field id.
                  renderAsLabel:
                    type: boolean
                    description: When true, render this parent-row field value as a read-only label in this step (guided edit mode).
                required: [id]
                additionalProperties: false
          description: |
            Allowlist of visible parent row field ids for this step.

            You can provide either:
            - A string field id: `"QTY"`
            - Or an object `{ id, renderAsLabel }` to make a field step-scoped read-only:
              `{ "id": "QTY", "renderAsLabel": true }`
        collapsedFieldsInHeader:
          type: boolean
          description: |
            Guided steps UX: when true and the underlying line group uses `ui.mode: "progressive"`,
            render the configured `ui.collapsedFields` controls in the row header and disable the
            collapse/expand toggle and progress pill.
            When the step only includes collapsed fields, the row body is hidden and only the header is shown.
        rows:
          $ref: '#/components/schemas/StepRowFilterConfig'
        validationRows:
          $ref: '#/components/schemas/StepRowFilterConfig'
          description: |
            Optional row filter used ONLY for guided-step validation/status (not rendering).
            This lets a step display rows differently than it validates them (e.g. show all rows, but only validate rows where QTY > 0).
            If omitted, `rows` is used for both rendering and validation.
        displayMode:
          type: string
          enum: [inline, overlay, inherit]
        readOnlyFields:
          type: array
          description: |
            Optional list of parent-row field ids to render as read-only labels in this step.
            Accepts either bare ids ("FIELD_ID") or prefixed ids ("GROUP__FIELD_ID" / "group.field_id"); prefixes are stripped.
          items:
            type: string
        subGroups:
          $ref: '#/components/schemas/StepSubGroupCollectionConfig'
      required: [kind, id]
      additionalProperties: true

    StepTargetConfig:
      oneOf:
        - $ref: '#/components/schemas/StepQuestionTargetConfig'
        - $ref: '#/components/schemas/StepLineGroupTargetConfig'

    ActionBarsConfig:
      type: object
      description: |
        Per-view configuration for the top and bottom action bars (system + custom buttons).

        Notes:
        - Omitted sections fall back to defaults.
        - Provide an empty config (e.g. `{ "items": [] }`) to intentionally hide a bar for a view.
      properties:
        top:
          $ref: '#/components/schemas/ActionBarTopConfig'
        bottom:
          $ref: '#/components/schemas/ActionBarBottomConfig'
        system:
          type: object
          description: Optional global system button tweaks.
          properties:
            home:
              type: object
              properties:
                hideWhenActive:
                  type: boolean
                  description: When true, hide the Home button while on the List (home) view.
      additionalProperties: true

    ActionBarTopConfig:
      type: object
      properties:
        sticky:
          type: boolean
          description: When true (default), keep the top action bar visible (sticky) below the header.
        list:
          $ref: '#/components/schemas/ActionBarViewConfig'
        form:
          $ref: '#/components/schemas/ActionBarViewConfig'
        summary:
          $ref: '#/components/schemas/ActionBarViewConfig'
      additionalProperties: true

    ActionBarBottomConfig:
      type: object
      properties:
        list:
          $ref: '#/components/schemas/ActionBarViewConfig'
        form:
          $ref: '#/components/schemas/ActionBarViewConfig'
        summary:
          $ref: '#/components/schemas/ActionBarViewConfig'
      additionalProperties: true

    ActionBarViewConfig:
      type: object
      description: Layout for one view’s action bar.
      properties:
        items:
          type: array
          description: Buttons rendered inside the capsule (left side).
          items:
            $ref: '#/components/schemas/ActionBarItemConfig'
        primary:
          type: array
          description: Primary buttons rendered outside the capsule (right side), e.g. Submit.
          items:
            $ref: '#/components/schemas/ActionBarItemConfig'
      additionalProperties: true

    ActionBarItemConfig:
      description: Action bar item (system button shorthand, system config object, or custom group).
      oneOf:
        - type: string
          enum: [home, create, edit, summary, actions, submit]
          description: Shorthand system button id.
        - $ref: '#/components/schemas/ActionBarSystemItemConfig'
        - $ref: '#/components/schemas/ActionBarCustomItemConfig'

    ActionBarSystemItemConfig:
      type: object
      required: [type, id]
      properties:
        type:
          type: string
          enum: [system]
        id:
          type: string
          enum: [home, create, edit, summary, actions, submit]
        hideWhenActive:
          type: boolean
          description: When true, hide this button when it is active for the current view.
        menuBehavior:
          type: string
          enum: [auto, menu, inline]
          description: |
            Menu behavior for `actions` (and `create`):
            - auto: 1 button -> render inline; 2+ -> actions menu
            - menu: always render a menu trigger
            - inline: always render all matched custom buttons inline
        placements:
          type: array
          description: |
            Which custom BUTTON placements should populate a system menu/inline list.

            - For `id: "actions"`: controls which custom buttons appear in the Actions menu (or inline list).
              If omitted, view-specific defaults are used (listBar/summaryBar/formSummaryMenu).
            - For `id: "create"` (when `actions` includes `createRecordPreset`): controls which preset buttons are listed inside the Create menu.
          items:
            type: string
            enum: [form, formSummaryMenu, summaryBar, topBar, topBarList, topBarForm, topBarSummary, listBar]
        actions:
          type: array
          description: |
            Optional filter for which custom button actions to include when this system item sources custom buttons.

            Examples:
            - Create menu presets: `"id": "create", "actions": ["createRecordPreset"]`
            - Actions menu PDFs only: `"id": "actions", "actions": ["renderDocTemplate"]`
          items:
            type: string
            enum: [renderDocTemplate, renderMarkdownTemplate, renderHtmlTemplate, createRecordPreset, updateRecord, openUrlField]
        summaryBehavior:
          type: string
          enum: [auto, navigate, menu]
          description: |
            Control how the Summary button behaves on the Form (edit) view.
            - auto: open a menu when formSummaryMenu buttons exist; otherwise navigate
            - navigate: always navigate to Summary
            - menu: always open the menu
        showCopyCurrentRecord:
          type: boolean
          description: Override whether the Create menu should include "Copy current record".
      additionalProperties: true

    ActionBarCustomItemConfig:
      type: object
      required: [type, placements]
      properties:
        type:
          type: string
          enum: [custom]
        placements:
          type: array
          description: Which custom BUTTON placements should be included.
          items:
            type: string
            enum: [form, formSummaryMenu, summaryBar, topBar, topBarList, topBarForm, topBarSummary, listBar]
        display:
          type: string
          enum: [inline, menu]
          description: |
            How to render these buttons.
            - inline: render each custom button as a standalone pill
            - menu: render a single menu trigger listing these buttons
        label:
          $ref: '#/components/schemas/LocalizedString'
          description: Optional label for the menu trigger when display=menu.
        actions:
          type: array
          description: Optional filter by action type (e.g. only show createRecordPreset buttons).
          items:
            type: string
            enum: [renderDocTemplate, renderMarkdownTemplate, renderHtmlTemplate, createRecordPreset, updateRecord, openUrlField]
      additionalProperties: true

    TemplateIdBase:
      oneOf:
        - type: string
          description: |
            Template reference (string).

            - Default: a Google Drive file id (for Doc/Markdown/HTML templates)
            - HTML-only shortcut: use `bundle:<filename>` to load an HTML template embedded from `/docs/templates/<filename>` at build time.
              This is faster and avoids Drive/cache dependencies (rendered client-side; may call `fetchDataSource` if projection placeholders are present), but requires a redeploy to update.
              Bundled templates may include small inline `<script>` blocks for dynamic UI behavior. Drive-sourced templates must not include `<script>` tags (rejected).
        - type: object
          additionalProperties:
            type: string

    TemplateIdCase:
      type: object
      required: [when, templateId]
      properties:
        when:
          $ref: '#/components/schemas/VisibilityCondition'
        templateId:
          $ref: '#/components/schemas/TemplateIdBase'

    TemplateIdSelector:
      type: object
      required: [cases]
      properties:
        cases:
          type: array
          description: Ordered list of conditional templates; first match wins.
          items:
            $ref: '#/components/schemas/TemplateIdCase'
        default:
          $ref: '#/components/schemas/TemplateIdBase'
          description: Optional fallback template when no cases match.

    TemplateIdMap:
      oneOf:
        - $ref: '#/components/schemas/TemplateIdBase'
        - $ref: '#/components/schemas/TemplateIdSelector'

    LocalizedString:
      oneOf:
        - type: string
        - type: object
          additionalProperties:
            type: string

    EmailRecipientEntry:
      oneOf:
        - type: string
        - $ref: '#/components/schemas/EmailRecipientDataSourceConfig'

    EmailRecipientDataSourceConfig:
      type: object
      required: [type, recordFieldId, lookupField, valueField, dataSource]
      properties:
        type:
          type: string
          enum: [dataSource]
        recordFieldId:
          type: string
        lookupField:
          type: string
        valueField:
          type: string
        dataSource:
          $ref: '#/components/schemas/DataSourceConfig'
        fallbackEmail:
          type: string

    FollowupStatusConfig:
      type: object
      description: Status values written by follow-up actions and used by the web app for status-aware UI.
      properties:
        inProgress:
          $ref: '#/components/schemas/LocalizedString'
          description: Status value for draft/in-progress records (used by autosave/list view defaults).
        reOpened:
          $ref: '#/components/schemas/LocalizedString'
          description: Status value written when explicitly re-opening a closed record.
        onPdf:
          $ref: '#/components/schemas/LocalizedString'
        onEmail:
          $ref: '#/components/schemas/LocalizedString'
        onClose:
          $ref: '#/components/schemas/LocalizedString'

    ListViewColumnConfig:
      oneOf:
        - $ref: '#/components/schemas/ListViewFieldColumnConfig'
        - $ref: '#/components/schemas/ListViewRuleColumnConfig'
      description: List view column config (either a direct field/meta column or a rule-based computed column).

    ListViewFieldColumnConfig:
      type: object
      properties:
        type:
          type: string
          enum: [field]
          description: Optional discriminator (omit for backward compatibility).
        fieldId:
          type: string
        label:
          oneOf:
            - type: string
            - type: object
              additionalProperties:
                type: string
        kind:
          type: string
          enum: [question, meta]
          description: Distinguishes user-defined question columns from system meta columns (Created/Updated/Status/PDF).
        showIn:
          oneOf:
            - type: string
              enum: [table, cards, both]
            - type: array
              items:
                type: string
                enum: [table, cards]
          description: |
            Optional visibility for list view modes.

            - Omit to show in both views.
            - `"table"` or `["table"]` to show only in the table view.
            - `"cards"` or `["cards"]` to show only in the cards/list view.
            - `"both"` or `["table","cards"]` to explicitly show in both.
      required:
        - fieldId

    ListViewRuleColumnConfig:
      type: object
      properties:
        type:
          type: string
          enum: [rule]
        fieldId:
          type: string
          description: Stable column id for this computed column (does not need to match a question id).
        label:
          $ref: '#/components/schemas/LocalizedString'
          description: Column header label.
        showIn:
          oneOf:
            - type: string
              enum: [table, cards, both]
            - type: array
              items:
                type: string
                enum: [table, cards]
          description: |
            Optional visibility for list view modes.

            - Omit to show in both views.
            - `"table"` or `["table"]` to show only in the table view.
            - `"cards"` or `["cards"]` to show only in the cards/list view.
            - `"both"` or `["table","cards"]` to explicitly show in both.
        hrefFieldId:
          type: string
          description: |
            Optional default URL field for the column. When set (and the matched case uses `style: "link"`),
            the cell opens the URL stored in this field (e.g. `pdfUrl` or any question id containing a URL).

            Cases can override via `cases[].hrefFieldId`.
        openView:
          $ref: '#/components/schemas/ListViewOpenViewConfig'
          description: |
            Which view opens when clicking the computed cell.

            Supports either a string (legacy) or an object `{ target, rowClick }`:
            - `auto`: preserve default list click behavior
            - `form`: force edit view (Closed records are read-only)
            - `summary`: force Summary view (falls back to form if Summary is disabled)
            - `button`: run a configured custom BUTTON action for the record (opens a preview overlay)
        openButtonId:
          type: string
          description: |
            When `openView: "button"`, the BUTTON id (or encoded id via `__ckQIdx=`) to trigger.

            Allowed button actions: renderDocTemplate / renderMarkdownTemplate / renderHtmlTemplate / openUrlField / updateRecord.
        sortable:
          type: boolean
          description: When true, allow sorting by the computed text value (default false).
        cases:
          type: array
          description: First match wins.
          items:
            $ref: '#/components/schemas/ListViewRuleCase'
        default:
          $ref: '#/components/schemas/ListViewRuleCaseDefault'
          description: Fallback when no cases match.
      required:
        - type
        - fieldId
        - label
        - cases

    ListViewRuleCaseDefault:
      type: object
      properties:
        text:
          $ref: '#/components/schemas/LocalizedString'
        style:
          type: string
          enum: [link, warning, muted, default]
        icon:
          type: string
          enum: [warning, check, error, info, external, lock, edit, copy, view]
        hrefFieldId:
          type: string
          description: 'Optional URL field to open when `style: "link"`.'
        openView:
          $ref: '#/components/schemas/ListViewOpenViewConfig'
          description: Optional override for which view opens when clicking the computed cell (falls back to column `openView`).
        openButtonId:
          type: string
          description: |
            When `openView.target: "button"` (or `openView: "button"`), the BUTTON id (or encoded id via `__ckQIdx=`) to trigger.
      required:
        - text

    ListViewRuleCase:
      type: object
      properties:
        when:
          $ref: '#/components/schemas/ListViewRuleWhen'
          description: Condition for the case; omitted means "always".
        text:
          $ref: '#/components/schemas/LocalizedString'
        style:
          type: string
          enum: [link, warning, muted, default]
        icon:
          type: string
          enum: [warning, check, error, info, external, lock, edit, view]
        hrefFieldId:
          type: string
          description: |
            Optional URL field to open when `style: "link"`.

            Example: `pdfUrl` or a question id that stores `https://...`.
        openView:
          $ref: '#/components/schemas/ListViewOpenViewConfig'
          description: |
            Optional override for which view opens when clicking this case's computed cell.

            If `{ target, rowClick: true }`, then clicking **any cell** on the row uses the same open target (not just the computed cell).
        openButtonId:
          type: string
          description: |
            When `openView.target: "button"` (or `openView: "button"`), the BUTTON id (or encoded id via `__ckQIdx=`) to trigger.
      required:
        - text

    ListViewOpenViewConfig:
      description: |
        Controls what happens when clicking a list view computed (rule) cell.

        Use a string for simple behavior, or an object to also control row click behavior.
      oneOf:
        - type: string
          enum: [auto, form, summary, button, copy, submit]
        - type: object
          properties:
            target:
              type: string
              enum: [auto, form, summary, button, copy, submit]
            rowClick:
              type: boolean
              description: When true, clicking any other cell on the row uses the same open target.
          required:
            - target

    ListViewRuleWhen:
      description: |
        Rule condition used by list view computed columns.

        Notes:
        - Use `{ "all": [...] }` for AND conditions.
        - Use `{ "any": [...] }` for OR conditions.
        - `isToday` / `isNotToday` treat `YYYY-MM-DD` as a **local date** (not UTC).
      oneOf:
        - $ref: '#/components/schemas/ListViewRulePredicate'
        - type: object
          properties:
            all:
              type: array
              items:
                $ref: '#/components/schemas/ListViewRuleWhen'
          required: [all]
        - type: object
          properties:
            any:
              type: array
              items:
                $ref: '#/components/schemas/ListViewRuleWhen'
          required: [any]

    ListViewRulePredicate:
      type: object
      properties:
        fieldId:
          type: string
          description: |
            Field id to evaluate.

            You can reference question IDs or system meta fields: `id`, `createdAt`, `updatedAt`, `status`, `pdfUrl`.
        equals:
          oneOf:
            - type: string
            - type: number
            - type: boolean
            - type: array
              items:
                oneOf:
                  - type: string
                  - type: number
                  - type: boolean
        notEquals:
          oneOf:
            - type: string
            - type: number
            - type: boolean
            - type: array
              items:
                oneOf:
                  - type: string
                  - type: number
                  - type: boolean
        notEmpty:
          type: boolean
        isToday:
          type: boolean
        isNotToday:
          type: boolean
      required:
        - fieldId

    ListViewLegendItem:
      type: object
      description: Legend entry displayed below the list view table (icon + explanatory text).
      properties:
        icon:
          type: string
          enum: [warning, check, error, info, external, lock, edit, copy, view]
          description: Optional icon name shown next to the text.
        pill:
          $ref: '#/components/schemas/ListViewLegendPill'
          description: Optional pill label shown before the legend text (neutral tones only).
        text:
          $ref: '#/components/schemas/LocalizedString'
          description: |
            Explanatory text shown next to the icon.

            Supports basic inline Markdown (`**bold**`, `*italic*`, `code`, and links).
      required:
        - text

    ListViewLegendPill:
      type: object
      description: Neutral pill token displayed inline with legend text.
      properties:
        text:
          $ref: '#/components/schemas/LocalizedString'
          description: Pill label text.
        tone:
          type: string
          enum: [default, muted, strong]
          description: Optional neutral tone for the pill style.
      required:
        - text

    ListViewConfig:
      type: object
      properties:
        title:
          oneOf:
            - type: string
            - type: object
              additionalProperties:
                type: string
          description: |
            Optional localized heading displayed above the list view.

            Set to an empty string (`""`) to hide the heading entirely.
        columns:
          type: array
          description: |
            Optional dashboard-defined columns for the list view.

            These columns are **prepended** before any questions marked `listView: true`, and before `metaColumns`.
            Use this to add computed/action columns based on record fields (for example: an Action column that shows
            Edit/View/Missing depending on status + DATE).
          items:
            $ref: '#/components/schemas/ListViewColumnConfig'
        metaColumns:
          type: array
          description: |
            Optional system columns appended after question columns.

            Notes:
            - When omitted, the app defaults to `["updatedAt"]`.
            - Use an explicit empty list `[]` to show no meta columns.
          items:
            type: string
            enum: [createdAt, updatedAt, status, pdfUrl]
        view:
          type: object
          description: |
            Controls how the List screen is rendered.

            - `mode: table` (default): the existing table view.
            - `mode: cards`: a record-list UI that only shows results **after searching** (to avoid overwhelming the user).
            - When `toggleEnabled: true`, users can switch between `table` and `cards` in the UI.
          properties:
            mode:
              type: string
              enum: [table, cards]
              description: Which view to show when the toggle is disabled (default `table`).
            toggleEnabled:
              type: boolean
              description: When true, show a toggle to switch between `table` and `cards`.
            defaultMode:
              type: string
              enum: [table, cards]
              description: |
                When `toggleEnabled: true`, which mode is selected initially (default `table`).
        search:
          type: object
          description: |
            Controls the List view search UI/behavior.

            - Default is `mode: text` (free-text search across visible list columns + system columns).
            - When `mode: date`, the List view shows a date picker and filters records by a specific date field.
            - When `mode: advanced`, the List view shows a Gmail-like multi-field filter panel.
          properties:
            mode:
              type: string
              enum: [text, date, advanced]
              description: Search mode (defaults to `text`).
            placeholder:
              oneOf:
                - type: string
                - $ref: '#/components/schemas/LocalizedString'
              description: |
                Optional placeholder text for the list search input.

                When omitted, the UI falls back to system strings (e.g., "Search records").
                Set to an empty string (`""`) to remove the placeholder text.
            presetsTitle:
              oneOf:
                - type: string
                - $ref: '#/components/schemas/LocalizedString'
              description: |
                Optional title shown inline before list view search preset buttons.
                Example: "View recipes:".
            dateFieldId:
              type: string
              description: |
                When `mode: date`, filter on this field id (typically a `DATE` question id).
                The list fetch projection is automatically expanded to include this field so filtering works even if the field is not visible as a column.
            fields:
              type: array
              items:
                type: string
              description: |
                When `mode: advanced`, the list of field ids that appear as filter rows in the advanced search panel.

                Notes:
                - Field ids can reference questions **or** meta columns like `createdAt`, `updatedAt`, `status`, `pdfUrl`.
                - The list fetch projection is automatically expanded to include these fields so filtering works even if the field is not visible as a column.
        legend:
          type: array
          description: |
            Optional legend displayed below the list view table to explain icons/visual indicators.

            Notes:
            - The legend is **only shown when you define it**.
            - Each legend entry can include an `icon`, or omit it for text-only legend lines.
            - Legend text supports basic inline Markdown (bold/italic/code/links).
          items:
            $ref: '#/components/schemas/ListViewLegendItem'
        defaultSort:
          type: object
          properties:
            fieldId:
              type: string
            direction:
              type: string
              enum: [asc, desc]
        headerSortEnabled:
          type: boolean
          description: |
            Optional UI setting: enable/disable interactive sorting by clicking table column headers.

            - When `true` or omitted (default), sortable columns render as clickable headers that update the sort field/direction.
            - When `false`, headers are non-interactive (the list still uses `defaultSort`).
        pageSize:
          type: integer
          description: Max rows per page (default 10, capped at 50).
        paginationControlsEnabled:
          type: boolean
          description: |
            Optional UI setting: hide pagination controls and render all matching rows.

            Notes:
            - Server list endpoints remain paginated for performance; this setting only controls the **UI** paging controls.
            - Default is true.
      description: Configuration for list views showing saved submissions.
      example:
        columns:
          - fieldId: dishName
          - fieldId: createdAt
            label:
              en: Created
              fr: Créé
        defaultSort:
          fieldId: createdAt
          direction: desc
        pageSize: 10


    DedupRule:
      type: object
      properties:
        id:
          type: string
        scope:
          type: string
          description: A `form` (default) or a `dataSourceId` if dedup checks another tab.
        keys:
          type: array
          items:
            type: string
          description: Field ids forming the uniqueness composite.
        matchMode:
          type: string
          enum: [exact, caseInsensitive]
          default: exact
        onConflict:
          type: string
          enum: [reject, ignore, merge]
          default: reject
        message:
          oneOf:
            - type: string
            - type: object
              additionalProperties:
                type: string
          description: User-facing error when `onConflict=reject`.
        mergeHandlerKey:
          type: string
          description: Only used when `onConflict=merge` to look up custom merge logic.
      required:
        - id
        - keys
      description: Deduplication rules evaluated at submission time.
      example:
        id: uniqueDishPerDay
        scope: form
        keys: [dishName, serviceDate]
        matchMode: caseInsensitive
        onConflict: reject
        message:
          en: This dish is already recorded for that date.
    DedupSheet:
      type: array
      description: |
        Optional per-form dedup sheet named "<ConfigSheetName> Dedup" with columns:
        1) Rule ID, 2) Scope (form or dataSourceId), 3) Keys (comma-separated field ids),
        4) Match mode (exact|caseInsensitive), 5) On conflict (reject|ignore|merge),
        6) Message (string or localized JSON).
      items:
        type: object
        properties:
          ruleId:
            type: string
          scope:
            type: string
          keys:
            type: string
          matchMode:
            type: string
          onConflict:
            type: string
          message:
            type: string

    PaginatedResult:
      type: object
      properties:
        items:
          type: array
          items:
            type: object
        nextPageToken:
          type: string
        totalCount:
          type: integer
      required:
        - items
      description: Generic paginated response wrapper for list endpoints (totalCount capped at 200).

    RecordMetadata:
      type: object
      properties:
        id:
          type: string
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    SelectionEffect:
      type: object
      properties:
        id:
          type: string
          description: |
            Optional stable identifier for this selection effect rule.
            When set, auto-created rows will be tagged with `__ckSelectionEffectId = id` so rules can reference the originating effect.
        type:
          type: string
          enum: [addLineItems, addLineItemsFromDataSource, deleteLineItems, setValue]
          description: |
            Effect type. `addLineItems` inserts rows with static presets.
            `addLineItemsFromDataSource` hydrates rows by looking up the selected value inside a data source row (supports JSON columns).
            `deleteLineItems` deletes previously-created child rows (typically the inverse of an `addLineItems` rule).
            `setValue` updates a field value in the current row (when triggered inside a line item) or at the top level.

            **Option filter enforcement:** When an effect creates rows (either via `preset` or via a data source),
            the target line-item/subgroup field `optionFilter` rules are treated as allowlists. Any generated row
            that sets a CHOICE/CHECKBOX value which is *not* allowed by the corresponding field’s `optionFilter`
            in the current context is skipped (useful for filtering out disallowed ingredient rows like “Salt”).
        groupId:
          type: string
          description: Target LINE_ITEM_GROUP id where rows are added/removed (required for add/delete effects).
        fieldId:
          type: string
          description: Target field id for `setValue` effects (uses the current row when triggered inside line items).
        value:
          oneOf:
            - type: string
            - type: number
            - type: boolean
            - type: array
              items:
                type: string
            - type: "null"
          description: |
            Value to set for `setValue` effects. Supports reference strings:
            - `$row.FIELD_ID`: copy from the originating line-item row (when the effect is triggered inside a line item)
            - `$top.FIELD_ID`: copy from the top-level record values
        targetPath:
          oneOf:
            - type: string
            - type: array
              items:
                type: string
          description: |
            Optional subgroup path for nested targets (dot-delimited string or array of subgroup ids).
            When provided, this path is resolved relative to the triggering row for true nesting.
        when:
          $ref: '#/components/schemas/WhenClause'
          description: Optional condition that must match for the effect to run.
        preset:
          type: object
          additionalProperties:
            oneOf:
              - type: string
              - type: number
              - type: boolean
              - type: array
                items:
                  type: string
          description: |
            Optional preset values for line-item fields when rows are added.
            Supports reference strings:
            - `$row.FIELD_ID`: copy from the originating line-item row (when the effect is triggered inside a line item)
            - `$top.FIELD_ID`: copy from the top-level record values
        triggerValues:
          type: array
          items:
            type: string
          description: Choice/checkbox values that trigger the effect (omit to trigger on any selection).
        hideRemoveButton:
          type: boolean
          description: |
            When true, rows created by this effect will hide the UI "Remove" action.
            (Useful for child rows that should be managed exclusively by selection effects.)
        targetEffectId:
          type: string
          description: |
            For `type=deleteLineItems`, optionally specify which `selectionEffects.id` to delete rows for.
            If omitted, the effect's own `id` is used.
        dataSource:
          $ref: '#/components/schemas/DataSourceConfig'
          description: Optional override for data-driven effects. Defaults to the question's own `dataSource`.
        lookupField:
          type: string
          description: Column/field used to match the selected value when `type=addLineItemsFromDataSource`.
        dataField:
          type: string
          description: Column/field that contains the serialized payload (typically JSON) used to create the line item rows.
        lineItemMapping:
          type: object
          additionalProperties:
            type: string
          description: Map of line item field ids to keys/paths inside each JSON entry (dot notation supported). Prefix with `$row.` to pull from the originating line-item row instead of the data-source payload.
        clearGroupBeforeAdd:
          type: boolean
          description: When true (default) the target line item group is cleared before new rows are inserted.
        aggregateBy:
          type: array
          items:
            type: string
          description: Explicit list of line item field ids to treat as grouping keys (non-numeric). Rows with the same values across these fields are merged.
        aggregateNumericFields:
          type: array
          items:
            type: string
          description: Line item field ids whose values should be summed even if their underlying line item field type is not NUMBER.
        rowMultiplierFieldId:
          type: string
          description: ID of the originating line-item field whose numeric value scales the generated rows (e.g., MEALS in a batch row).
        dataSourceMultiplierField:
          type: string
          description: Column/field in the data source row representing the baseline quantity used to normalize the multiplier (e.g., "Meals" column in the recipe sheet).
        scaleNumericFields:
          type: array
          items:
            type: string
          description: Explicit list of mapped line-item field ids whose numeric values should be multiplied by the computed scale factor. Defaults to `aggregateNumericFields` when omitted.

    VisibilityCondition:
      type: object
      properties:
        fieldId:
          type: string
        equals:
          oneOf:
            - type: string
            - type: array
              items:
                type: string
        greaterThan:
          oneOf:
            - type: number
            - type: string
        lessThan:
          oneOf:
            - type: number
            - type: string
        notEmpty:
          type: boolean
          description: If true, condition matches when the field has any value other than empty/blank/null. If false, condition matches when the field is empty.
        isEmpty:
          type: boolean
          description: |
            Alias for `notEmpty: false`. If true, condition matches when the field is empty; if false, matches when non-empty.

    LineItemWhenClause:
      type: object
      required: [lineItems]
      properties:
        lineItems:
          type: object
          required: [groupId]
          properties:
            groupId:
              type: string
              description: Line item group question id whose rows should be evaluated.
            subGroupId:
              type: string
              description: Optional subgroup id to evaluate (scans all parent rows). Prefer `subGroupPath` for deep nesting.
            subGroupPath:
              oneOf:
                - type: string
                - type: array
                  items:
                    type: string
              description: |
                Optional subgroup path to evaluate (dot-delimited string or array of subgroup ids).
                Supports wildcards: "*" for one level, "**" for any depth (including zero levels).
            match:
              type: string
              enum: [any, all]
              description: Row matching mode; defaults to `any`.
            when:
              $ref: '#/components/schemas/WhenClause'
              description: Row-level condition applied within each row (evaluated against row/subgroup values only).
            parentWhen:
              $ref: '#/components/schemas/WhenClause'
              description: Optional condition evaluated against parent or ancestor rows when subgroup matching is used.
            parentMatch:
              type: string
              enum: [any, all]
              description: Parent-row matching mode; defaults to `any`.
            parentScope:
              type: string
              enum: [immediate, ancestor]
              description: When parentWhen is provided, controls whether to match only the direct parent or any ancestor.
          additionalProperties: false
      additionalProperties: false

    WhenClause:
      description: |
        Condition clause used by visibility, validation, rowDisclaimer, and guided-step row filters.

        Supports both:
        - Leaf conditions (single field): `fieldId` + comparator(s) like `equals`, `greaterThan`, `lessThan`, `notEmpty`, `isEmpty`
        - Line-item conditions: `lineItems: { groupId, subGroupId?, subGroupPath?, when?, match?, parentWhen?, parentScope?, parentMatch? }`
        - Compound conditions:
          - `all`: AND (every entry must match)
          - `any`: OR (at least one entry must match)
          - `not`: NOT (negates a nested clause; useful for "not in" patterns)
      oneOf:
        - $ref: '#/components/schemas/VisibilityCondition'
        - $ref: '#/components/schemas/LineItemWhenClause'
        - type: object
          required: [all]
          properties:
            all:
              type: array
              items:
                $ref: '#/components/schemas/WhenClause'
          additionalProperties: false
        - type: object
          required: [any]
          properties:
            any:
              type: array
              items:
                $ref: '#/components/schemas/WhenClause'
          additionalProperties: false
        - type: object
          required: [not]
          properties:
            not:
              $ref: '#/components/schemas/WhenClause'
          additionalProperties: false

    VisibilityConfig:
      type: object
      properties:
        showWhen:
          $ref: '#/components/schemas/WhenClause'
        hideWhen:
          $ref: '#/components/schemas/WhenClause'
      description: Show/hide logic tied to another field value.

    LineItemSelectorConfig:
      type: object
      properties:
        id:
          type: string
          description: ID used by option filters or validation rules to read the selector value.
        labelEn:
          type: string
        labelFr:
          type: string
        labelNl:
          type: string
        placeholder:
          $ref: '#/components/schemas/LocalizedString'
          description: Placeholder text for the selector input.
        placeholderEn:
          type: string
        placeholderFr:
          type: string
        placeholderNl:
          type: string
        helperText:
          $ref: '#/components/schemas/LocalizedString'
          description: Optional helper text for selector-overlay search prompts.
        helperTextEn:
          type: string
        helperTextFr:
          type: string
        helperTextNl:
          type: string
        hideLabel:
          type: boolean
          description: When true, hide the selector label (placeholder only).
        optionsRef:
          type: string
          description: REF:TabName pointing to a 3-column list of options for the selector.
        options:
          type: array
          items:
            type: string
        optionsFr:
          type: array
          items:
            type: string
        optionsNl:
          type: array
          items:
            type: string
        required:
          type: boolean
          description: Whether the selector is required before adding lines.
        choiceSearchEnabled:
          type: boolean
          description: |
            For selectors rendered as a select, enable a type-to-search input.

            - When `true`, always use the searchable control (even for smaller lists)
            - When `false`, always use the native select (no search)
            - When omitted, the UI enables it automatically only for large option sets
        optionFilter:
          $ref: '#/components/schemas/OptionFilter'
          description: |
            Optional filter for the selector options themselves. Supports `optionMap` or `optionMapRef` (including multi-column keys).
            Useful for cascading selectors where available sections depend on other fields.

    LineItemAddOverlayConfig:
      type: object
      properties:
        title:
          $ref: '#/components/schemas/LocalizedString'
          description: Optional title for the multi-select add overlay.
        helperText:
          $ref: '#/components/schemas/LocalizedString'
          description: Optional helper text shown under the title in the multi-select add overlay.
        placeholder:
          $ref: '#/components/schemas/LocalizedString'
          description: Optional placeholder text for the overlay search input.

    LineItemTotalConfig:
      type: object
      properties:
        type:
          type: string
          enum: [sum, count]
          description: Use `sum` to add numeric field values or `count` to count rows.
        fieldId:
          type: string
          description: Line item field ID to sum (ignored for `count`).
        label:
          oneOf:
            - type: string
            - type: object
              additionalProperties:
                type: string
          description: Optional label shown before the aggregated value (supports localization keys).
        decimalPlaces:
          type: integer
          description: Optional decimal precision for totals.

    LineItemDedupRule:
      type: object
      properties:
        fields:
          type: array
          items:
            type: string
          description: Field ids that must be unique together within the group/subgroup.
        message:
          oneOf:
            - type: string
            - $ref: '#/components/schemas/LocalizedString'
          description: Optional localized error message for duplicate rows (supports {value} placeholder).
      required: [fields]

    ValidationRule:
      type: object
      properties:
        level:
          type: string
          enum: [error, warning]
          description: Optional severity; defaults to `error`. Use `warning` to surface a message without blocking submission.
        warningDisplay:
          type: string
          enum: [top, field, both]
          description: |
            Warning-only display preference for UI surfaces (edit + summary). Defaults to `top`.
            - top: show in the warnings banner only
            - field: show only under the target field
            - both: show in both places
        warningView:
          type: string
          enum: [edit, summary, both]
          description: |
            Warning-only view preference for UI surfaces. Defaults to `both`.
            - edit: show warnings only on the edit (form) view
            - summary: show warnings only on the summary view
            - both: show warnings on both views
        when:
          $ref: '#/components/schemas/WhenClause'
        then:
          type: object
          properties:
            fieldId:
              type: string
            required:
              type: boolean
              description: If true, target field must have a value when the condition matches.
            min:
              oneOf:
                - type: number
                - type: string
              description: Enforce target numeric value >= min.
            minFieldId:
              type: string
              description: Enforce target numeric value >= the numeric value of another field (skips if the referenced field is empty/non-numeric). If both `min` and `minFieldId` are set, `min` wins.
            max:
              oneOf:
                - type: number
                - type: string
              description: Enforce target numeric value <= max.
            maxFieldId:
              type: string
              description: Enforce target numeric value <= the numeric value of another field (skips if the referenced field is empty/non-numeric). If both `max` and `maxFieldId` are set, `max` wins.
            integer:
              type: boolean
              description: When true, enforce the target numeric value is a whole number (no decimals). Skips empty values unless required is also set.
            allowed:
              type: array
              items:
                type: string
            disallowed:
              type: array
              items:
                type: string
        message:
          oneOf:
            - type: string
            - type: object
              properties:
                en:
                  type: string
                fr:
                  type: string
                nl:
                  type: string
              additionalProperties:
                type: string
        phase:
          type: string
          enum: [submit, followup, both]
          description: Optional scope; defaults to "both". Use "followup" to enforce a rule only during follow-up actions (e.g., require FINAL_QTY then).
      required:
        - when
      anyOf:
        - required: [then]
        - required: [message]
      description: |
        Conditional validation rule.
        - Use `when` + `then` to enforce requirements/constraints on a target field.
        - Use `when` + `message` (omitting `then`) to emit a message when the condition matches (useful for warning-only rules).
      example:
        when:
          fieldId: Product
          equals: Carrots
        then:
          fieldId: Unit
          allowed: [Crates]
        message: Carrots must be recorded in crates.

    LineItemSheet:
      type: array
      description: |
        Structure of the separate sheet referenced by `REF:SheetName` for LINE_ITEM_GROUP questions.
        Columns should be: ID, Type, Label EN, Label FR, Label NL, Required?, Options (EN), Options (FR), Options (NL), Config JSON.
        Type must be one of DATE, TEXT, PARAGRAPH, NUMBER, CHOICE, CHECKBOX.
        The Config JSON (column 10) can optionally include `optionFilter` and/or `validationRules` per line-item field.
      items:
        type: object
        properties:
          id:
            type: string
          type:
            type: string
            enum: [DATE, TEXT, PARAGRAPH, NUMBER, CHOICE, CHECKBOX]
          labelEn:
            type: string
          labelFr:
            type: string
          labelNl:
            type: string
          required:
            type: boolean
          options:
            type: string
            description: Option values for CHOICE/CHECKBOX in English, or REF:Options_sheet.
          optionsFr:
            type: string
          optionsNl:
            type: string

    OptionsSheet:
      type: array
      description: |
        Structure of the separate sheet referenced by `REF:SheetName`.
        Contains three columns defining options in each language.
      items:
        type: object
        properties:
          optionEn:
            type: string
            description: Option text in English (Column A).
          optionFr:
            type: string
            description: Option text in French (Column B).
          optionNl:
            type: string
            description: Option text in Dutch (Column C).

    ConfigSheet:
      type: array
      description: A collection of question configurations defining a form.
      items:
        $ref: '#/components/schemas/QuestionConfig'

    FormConfigExport:
      type: object
      description: |
        Full form configuration export produced by fetchFormConfig(formKey) or by appending ?config=1 to the web app URL.
        Includes dashboard-level settings, all questions (active + archived), dedup rules, and the computed WebFormDefinition.
        Save these exports under docs/config/exports to bundle them into the Apps Script build.
        When a bundled export exists, the app can use it to override sheet-based configuration reads.
      properties:
        formKey:
          type: string
          description: Resolved form key (config sheet name or form title).
        generatedAt:
          type: string
          format: date-time
          description: ISO timestamp when the export was generated.
        form:
          $ref: '#/components/schemas/FormDashboardConfig'
        questions:
          type: array
          items:
            $ref: '#/components/schemas/QuestionConfig'
        dedupRules:
          type: array
          items:
            $ref: '#/components/schemas/DedupRule'
        definition:
          type: object
          description: Computed WebFormDefinition for active questions.
          additionalProperties: true
        validationErrors:
          type: array
          items:
            type: string
      required:
        - formKey
        - generatedAt
        - form
        - questions
        - dedupRules
        - definition
        - validationErrors

    FormDashboardConfig:
      type: object
      description: Parsed Forms Dashboard row for the selected form (dashboard-level settings).
      properties:
        title:
          type: string
        configSheet:
          type: string
        destinationTab:
          type: string
        description:
          type: string
        formId:
          type: string
        appUrl:
          type: string
        rowIndex:
          type: integer
        templateCacheTtlSeconds:
          type: integer
        followupConfig:
          type: object
          description: Parsed follow-up configuration (templates, recipients, list view, status transitions, etc).
          additionalProperties: true
        listViewTitle:
          $ref: '#/components/schemas/LocalizedString'
        listViewDefaultSort:
          type: object
          additionalProperties: true
        listViewPageSize:
          type: integer
        listViewPaginationControlsEnabled:
          type: boolean
        listViewHeaderSortEnabled:
          type: boolean
        listViewMetaColumns:
          type: array
          items:
            type: string
        listViewColumns:
          type: array
          items:
            $ref: '#/components/schemas/ListViewColumnConfig'
        listViewLegend:
          type: array
          items:
            $ref: '#/components/schemas/ListViewLegendItem'
        listViewSearch:
          type: object
          description: List view search config (dashboard-level).
          additionalProperties: true
        listViewView:
          type: object
          description: List view mode config (dashboard-level).
          additionalProperties: true
        languages:
          type: array
          items:
            type: string
            enum: [EN, FR, NL]
        defaultLanguage:
          type: string
          enum: [EN, FR, NL]
        languageSelectorEnabled:
          type: boolean
        autoSave:
          type: object
          description: Draft autosave configuration (dashboard-level).
          additionalProperties: true
        summaryViewEnabled:
          type: boolean
        summaryHtmlTemplateId:
          $ref: '#/components/schemas/TemplateIdMap'
        copyCurrentRecordEnabled:
          type: boolean
        copyCurrentRecordDropFields:
          type: array
          items:
            type: string
        createButtonLabel:
          $ref: '#/components/schemas/LocalizedString'
        copyCurrentRecordLabel:
          $ref: '#/components/schemas/LocalizedString'
        createNewRecordEnabled:
          type: boolean
        createRecordPresetButtonsEnabled:
          type: boolean
        actionBars:
          $ref: '#/components/schemas/ActionBarsConfig'
        appHeader:
          $ref: '#/components/schemas/AppHeaderConfig'
        groupBehavior:
          $ref: '#/components/schemas/GroupBehaviorConfig'
        submitValidation:
          $ref: '#/components/schemas/SubmitValidationConfig'
        steps:
          $ref: '#/components/schemas/StepsConfig'
        portraitOnly:
          type: boolean
        submissionConfirmationMessage:
          $ref: '#/components/schemas/LocalizedString'
        submissionConfirmationTitle:
          $ref: '#/components/schemas/LocalizedString'
        submissionConfirmationConfirmLabel:
          $ref: '#/components/schemas/LocalizedString'
        submissionConfirmationCancelLabel:
          $ref: '#/components/schemas/LocalizedString'
        dedupDialog:
          $ref: '#/components/schemas/DedupDialogConfig'
        submitButtonLabel:
          $ref: '#/components/schemas/LocalizedString'
        summaryButtonLabel:
          $ref: '#/components/schemas/LocalizedString'
      additionalProperties: true
    BuildBundleConfig:
      type: object
      description: |
        Build/deploy-time settings (not stored in the config sheet).
        Use these to keep staging/prod bundles separate when exporting configs.
      properties:
        configEnv:
          type: string
          description: |
            Environment name used for bundle selection (e.g., "staging" or "prod").
            When set, config exports should be saved to `docs/config/exports/<env>/`
            and the build should embed only that environment's exports.
    ScriptPropertiesConfig:
      type: object
      description: |
        Google Apps Script Script Properties consumed by the web app at runtime.
      properties:
        CK_UI_ENV_TAG:
          type: string
          description: |
            Optional label rendered in the web app header to indicate the environment (e.g., "Staging").
            Set this in Apps Script: Project Settings → Script properties.
