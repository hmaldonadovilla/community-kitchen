openapi: 3.0.0
info:
  title: Community Kitchen Config Sheet Schema
  version: 1.0.0
  description: |
    Schema definition for the Configuration Sheet used to generate forms. The React web template is the only supported experience for deployed web apps; the legacy iframe UI has been retired, so no sheet-level configuration or query parameters are required for toggling views.
paths: {}
components:
  schemas:
    QuestionConfig:
      type: object
      properties:
        id:
          type: string
          description: Question identifier (e.g., `Q1`). Generated automatically if omitted.
        type:
          type: string
          enum: [DATE, TEXT, PARAGRAPH, NUMBER, CHOICE, CHECKBOX, FILE_UPLOAD, LINE_ITEM_GROUP]
          description: The type of the input field.
        qEn:
          type: string
          description: Question text in English.
        qFr:
          type: string
          description: Question text in French.
        qNl:
          type: string
          description: Question text in Dutch.
        required:
          type: boolean
          description: Whether the question is mandatory.
        ui:
          $ref: '#/components/schemas/QuestionUiConfig'
          description: |
            Optional UI hints for how this question should render in the edit view.
            Most fields can stay on `auto` and the UI will choose an iOS-friendly control based on option count; you can override per field.
        group:
          $ref: '#/components/schemas/QuestionGroupConfig'
          description: |
            Optional group card configuration for the edit view.
            Fields with the same group (by `id`, or by `title` if no `id` is provided) are rendered together inside a card section in the form body.
            If `collapsible` is enabled, the section can be collapsed/expanded by the user.
        pair:
          type: string
          description: |
            Optional "pair key" for explicit two-up layout.
            Fields with the same `pair` key will be rendered next to each other on the same row (when space permits).
            If `pair` is not set (or no matching pair is found), the field takes the full row.
        header:
          type: boolean
          deprecated: true
          description: |
            Deprecated. Use `group: { header: true, title: "Header" }` instead.
            Previously: when true, the edit view rendered this question in the sticky header area.
        options:
          type: string
          description: |
            Defines the options for CHOICE/CHECKBOX questions.
            Must be a reference string in the format `REF:SheetName` pointing to a separate sheet.
            The referenced sheet must contain three columns: Options (EN), Options (FR), Options (NL).
            Inline comma-separated lists are also supported for quick setup.
            Ignored for FILE_UPLOAD and LINE_ITEM_GROUP.
            For CHECKBOX questions: when no options are provided (and no `dataSource` is set), the UI treats the field as a consent boolean and renders a single checkbox.
        optionFilter:
          $ref: '#/components/schemas/OptionFilter'
          description: Optional dependency to filter options based on other field value(s).
        valueMap:
          $ref: '#/components/schemas/ValueMapConfig'
          description: Readonly TEXT helper that derives its value from another field using a map (arrays join with ", ").
        dataSource:
          $ref: '#/components/schemas/DataSourceConfig'
          description: |
            Optional remote data source for options or prefills. Use when a question's options should come from a backend source instead of static options/ref sheets.
        selectionEffects:
          type: array
          items:
            $ref: '#/components/schemas/SelectionEffect'
          description: |
            Effects triggered when specific choices/checkbox values are selected (e.g., auto-add line items with prefilled values).
        validationRules:
          type: array
          items:
            $ref: '#/components/schemas/ValidationRule'
          description: Cross-field validation rules for this question.
        derivedValue:
          $ref: '#/components/schemas/DerivedValueConfig'
          description: Computed value helper (e.g., add days to a date). Useful for hidden/system fields like expiration dates.
        visibility:
          $ref: '#/components/schemas/VisibilityConfig'
          description: Show or hide this question based on another field value.
        clearOnChange:
          type: boolean
          description: If true, changing this field clears all other fields and line items.
        uploadConfig:
          $ref: '#/components/schemas/FileUploadConfig'
          description: Additional settings for FILE_UPLOAD questions. Provide as JSON in the `Config (JSON/REF)` column.
        lineItemConfig:
          $ref: '#/components/schemas/LineItemGroupConfig'
          description: Settings for LINE_ITEM_GROUP questions. Provide as JSON or `REF:SheetName` in the `Config (JSON/REF)` column.
        status:
          type: string
          enum: [Active, Archived]
          description: Status of the question. Archived questions are ignored during form generation.
        listViewSort:
          type: object
          description: Optional list-view sort metadata applied when rendering saved submissions.
          properties:
            direction:
              type: string
              enum: [asc, desc]
            priority:
              type: integer
              description: Lower numbers are evaluated first.
        listView:
          type: boolean
          description: When true, this question appears in the list view.
        autoIncrement:
          type: object
          properties:
            prefix:
              type: string
            padLength:
              type: integer
            propertyKey:
              type: string
          description: Auto-generated ID metadata for TEXT fields.
      required: [id, type, qEn, qFr, qNl, required, status]

    FileUploadConfig:
      type: object
      properties:
        destinationFolderId:
          type: string
          description: Optional Drive folder ID where uploaded files should be stored.
        maxFiles:
          type: integer
          description: Maximum number of files allowed for this upload question.
        maxFileSizeMb:
          type: number
          description: Maximum file size in MB. Files larger than this are ignored.
        allowedExtensions:
          type: array
          items:
            type: string
          description: List of allowed file extensions (e.g., ['jpg', 'png', 'pdf']).
      description: |
        Upload settings consumed by FILE_UPLOAD questions. The React UI renders drag-and-drop dropzones that enforce these caps, show remaining slots + total size, and announce state changes for assistive tech. When `CK_DEBUG` (and thus `__WEB_FORM_DEBUG__`) is enabled the form also emits `[ReactForm] upload.*` diagnostics in DevTools for every add/drop/remove.

    LineItemFieldConfig:
      type: object
      properties:
        id:
          type: string
          description: Internal identifier for the line item field.
        type:
          type: string
          enum: [DATE, TEXT, PARAGRAPH, NUMBER, CHOICE, CHECKBOX, FILE_UPLOAD]
        labelEn:
          type: string
        labelFr:
          type: string
        labelNl:
          type: string
        required:
          type: boolean
        ui:
          $ref: '#/components/schemas/QuestionUiConfig'
          description: Optional UI hints for how this line item field should render (e.g., use segmented/radio/select for CHOICE).
        group:
          $ref: '#/components/schemas/QuestionGroupConfig'
          description: |
            Optional group card configuration for the edit view inside a line-item row (or subgroup overlay).
            Fields with the same group (by `id`, or by `title` if no `id` is provided) are rendered together inside a card section.
        pair:
          type: string
          description: |
            Optional "pair key" for explicit two-up layout inside line-item rows and subgroup overlays.
            Fields with the same `pair` key will be rendered next to each other on the same row (when space permits).
            If `pair` is not set (or no matching pair is found), the field takes the full row.
        options:
          type: array
          items:
            type: string
        optionsFr:
          type: array
          items:
            type: string
        optionsNl:
          type: array
          items:
            type: string
        optionFilter:
          $ref: '#/components/schemas/OptionFilter'
          description: Optional dependency to filter options based on another line item field or a top-level field value.
        validationRules:
          type: array
          items:
            $ref: '#/components/schemas/ValidationRule'
          description: Cross-field validation rules inside the line item row.
        derivedValue:
          $ref: '#/components/schemas/DerivedValueConfig'
          description: Computed value helper for a line-item field (e.g., auto-calc expiry per row).
        visibility:
          $ref: '#/components/schemas/VisibilityConfig'
          description: Show/hide logic for this line item field based on another value.
        dataSource:
          $ref: '#/components/schemas/DataSourceConfig'
          description: Optional data source for CHOICE/CHECKBOX line-item fields. When present, options are hydrated just like top-level questions.
        selectionEffects:
          type: array
          items:
            $ref: '#/components/schemas/SelectionEffect'
          description: Selection effects supported on line-item fields (triggered per row once required fields are complete).
        valueMap:
          $ref: '#/components/schemas/ValueMapConfig'
          description: Readonly TEXT helper that derives its value from another field using a map (arrays join with ", ").
        uploadConfig:
          $ref: '#/components/schemas/FileUploadConfig'
          description: Additional settings for FILE_UPLOAD line-item fields.

    LineItemGroupConfig:
      type: object
      properties:
        label:
          $ref: '#/components/schemas/LocalizedString'
          description: Optional localized label rendered as the subgroup title; falls back to `id` when omitted.
        ui:
          $ref: '#/components/schemas/LineItemGroupUiConfig'
          description: Optional UI settings for how line item rows are rendered (e.g., progressive disclosure).
        minRows:
          type: integer
          description: Minimum number of line item rows required.
        maxRows:
          type: integer
          description: Maximum number of line item rows allowed.
        addButtonLabel:
          $ref: '#/components/schemas/LocalizedString'
          description: Custom labels for the "Add line" button in each language.
        anchorFieldId:
          type: string
          description: ID of the line-item field used as anchor when bulk-adding rows.
        addMode:
          type: string
          enum: [overlay, inline, auto]
          description: |
            How rows are added for this line-item group.
            - overlay: open a multi-select overlay for the anchor CHOICE field, then create one row per selected value.
            - auto: automatically add/recompute rows when the anchor field's `optionFilter.dependsOn` fields are filled (one row per allowed anchor option). Auto-generated rows are overwritten when dependencies change, while manual rows are preserved.
            - inline: default; show a simple "Add line" button and create an empty row per click.
        sectionSelector:
          $ref: '#/components/schemas/LineItemSelectorConfig'
          description: Optional selector rendered above the line items to scope filters/validation rules (options can come from a REF tab).
        totals:
          type: array
          items:
            $ref: '#/components/schemas/LineItemTotalConfig'
          description: Totals to show under the line items (sum numeric fields or count rows).
        fields:
          type: array
          items:
            $ref: '#/components/schemas/LineItemFieldConfig'
          description: |
            Line item field definitions. If `Config (JSON/REF)` uses `REF:SheetName`, the fields are pulled from that sheet (columns: ID, Type, Label EN/FR/NL, Required?, Options EN/FR/NL, Config JSON in column 10).
            The optional Config JSON column on that ref sheet can include `optionFilter` and `validationRules` for each line-item field.
            You can mix a `REF:SheetName` for field definitions with inline JSON in `Config (JSON/REF)` to set `addMode`, `addButtonLabel`, `anchorFieldId`, `minRows`, `maxRows`, and other group-level settings even when the fields themselves come from the ref sheet.
        subGroups:
          type: array
          description: |
            Optional nested line-item groups that render under each parent row (e.g., Ingredients under each Dish header).
            Each child supports the same structure as `LineItemGroupConfig` (min/max/addMode/fields/optionFilter/selectionEffects/totals)
            and may also specify `ref: "REF:TabName"` to load its fields from a ref sheet (same column format as parent line-item refs);
            inline values override the ref.
            The web UI renders each subgroup with a localized title (from `label`, falling back to `id`) and a per-row Show/Hide toggle to collapse or expand its contents without affecting stored data.
            In progressive edit mode (`ui.mode: "progressive"`), subgroup rows are edited in a full-page overlay opened from buttons next to triggering fields (selection effects) or fallback subgroup buttons.
          items:
            $ref: '#/components/schemas/LineItemGroupConfig'
      required: [fields]

    LineItemCollapsedFieldConfig:
      type: object
      properties:
        fieldId:
          type: string
          description: Line item field ID to show in collapsed view.
        showLabel:
          type: boolean
          description: When false, omit the label in collapsed view (control/value only). Defaults to true.
      required: [fieldId]

    QuestionUiConfig:
      type: object
      properties:
        control:
          type: string
          enum: [auto, select, radio, segmented, switch]
          description: |
            Control variant for CHOICE fields.
            - auto: choose iOS-friendly defaults (segmented for <=3, radio for <=6, else select; boolean-like non-required choices may render as switch)
            - select: native dropdown (best for long option lists)
            - radio: radio list
            - segmented: iOS segmented control
            - switch: iOS switch (recommended only for boolean/non-required CHOICE fields)
        labelLayout:
          type: string
          enum: [auto, stacked]
          description: |
            Label/control layout hint.
            - auto: default behavior (inline on full-width rows; stacked in 2-up grids)
            - stacked: force label above control even for full-width rows

    QuestionGroupConfig:
      type: object
      properties:
        id:
          type: string
          description: Optional stable group id. Recommended if you have multiple groups.
        header:
          type: boolean
          description: |
            Marks this as the "header group" (fields previously rendered in the sticky header).
            Header groups render in the form body as a collapsible card section.
        title:
          $ref: '#/components/schemas/LocalizedString'
          description: Optional group title shown in the card header.
        collapsible:
          type: boolean
          description: When true, the group card can be collapsed/expanded. Defaults to true when title is set.
        defaultCollapsed:
          type: boolean
          description: Initial collapsed state (only applies when collapsible is true). Defaults to false.

    LineItemGroupUiConfig:
      type: object
      properties:
        mode:
          type: string
          enum: [default, progressive]
          description: |
            UI mode for this line item group.
            - default: existing editor behavior
            - progressive: rows are collapsed by default and can be expanded once collapsed fields are valid
        collapsedFields:
          type: array
          items:
            $ref: '#/components/schemas/LineItemCollapsedFieldConfig'
          description: |
            Field(s) rendered (and editable) while a row is collapsed. Typically 1–2 fields to keep the list compact.
        expandGate:
          type: string
          enum: [collapsedFieldsValid, always]
          description: |
            Controls when the expand toggle is enabled.
            - collapsedFieldsValid: enabled only when collapsedFields are filled and pass configured validation/visibility rules
            - always: always enabled
            When combined with `addMode: auto`, rows that are still gated/disabled are ignored during submit validation, and required LINE_ITEM_GROUP questions require at least one enabled+valid row.
        defaultCollapsed:
          type: boolean
          description: Default collapsed state for each row. When omitted and mode=progressive, defaults to true.
        rowDisclaimer:
          $ref: '#/components/schemas/RowDisclaimerConfig'
          description: |
            Optional per-row disclaimer shown in the UI (works for both line item groups and subgroups).
            Supports localization and simple template interpolation using row field values.

            - Use `{{FIELD_ID}}` to insert a row field value.
            - Includes `{{__ckRowSource}}` (auto/manual) and `{{__ckRowSourceLabel}}` (localized).

    RowDisclaimerRule:
      type: object
      required: [text]
      properties:
        when:
          $ref: '#/components/schemas/VisibilityCondition'
          description: Optional condition evaluated against the current row values.
        text:
          $ref: '#/components/schemas/LocalizedString'
          description: Disclaimer text (supports placeholders like {{FIELD_ID}}).

    RowDisclaimerConfig:
      oneOf:
        - $ref: '#/components/schemas/LocalizedString'
        - type: object
          properties:
            template:
              $ref: '#/components/schemas/LocalizedString'
              description: Default disclaimer template (supports placeholders).
            cases:
              type: array
              items:
                $ref: '#/components/schemas/RowDisclaimerRule'
              description: Ordered list of conditional disclaimer rules; first match wins.
            fallback:
              $ref: '#/components/schemas/LocalizedString'
              description: Fallback disclaimer when no cases match and no template is set.

    OptionFilter:
      type: object
      properties:
        dependsOn:
          oneOf:
            - type: string
            - type: array
              items:
                type: string
          description: |
            ID(s) of the field(s) whose value determines allowed options. Accepts a single ID or an ordered array for composite dependencies. When used inside line items, IDs can point to either sibling line-item fields or top-level fields.
        optionMap:
          type: object
          additionalProperties:
            type: array
            items:
              type: string
          description: |
            Mapping of parent value(s) -> allowed options for this field. For multiple dependencies, join values with `||` in the order listed in `dependsOn` (e.g., `"Carrots||Local"`). Use `"*"` as a fallback key.
      example:
        dependsOn: [Product, Supplier]
        optionMap:
          "Carrots||Local": [Crates]
          Carrots: [Bags, Crates]
          "*": [Bags]

    ValueMapConfig:
      type: object
      properties:
        dependsOn:
          type: string
          description: Field ID whose value is used to look up the mapped output.
        optionMap:
          type: object
          additionalProperties:
            type: array
            items:
              type: string
          description: Map of dependency value -> array of strings; arrays are joined with ", " for the readonly TEXT value. Supports `*` fallback.
      required: [dependsOn, optionMap]
      example:
        dependsOn: ING
        optionMap:
          Yogurt: [Milk]
          Pesto: [Milk, Peanuts]
          "*": [None]

    DerivedValueConfig:
      oneOf:
        - type: object
          required: [op, dependsOn]
          properties:
            op:
              type: string
              enum: [addDays]
              description: Add (or subtract) days from a base date field.
            dependsOn:
              type: string
              description: ID of the source field to base the calculation on (a DATE value or parseable date string).
            offsetDays:
              type: integer
              description: Number of days to add (can be negative).
            when:
              type: string
              enum: [always, empty]
              description: |
                When to apply the derived value.
                - always: recompute on every change (default for addDays)
                - empty: only set when the target field is empty (allows user overrides)
            hidden:
              type: boolean
              description: Informational flag to mark the field as system-managed/hidden in UI.
          description: Compute a date field automatically (e.g., expiration date = prep date + 2 days).
        - type: object
          required: [op]
          properties:
            op:
              type: string
              enum: [today]
              description: Prefill a DATE field with the current local date (YYYY-MM-DD).
            when:
              type: string
              enum: [always, empty]
              description: |
                When to apply the derived value.
                - empty: default for today (prefill behavior)
                - always: recompute on every change
            hidden:
              type: boolean
              description: Informational flag to mark the field as system-managed/hidden in UI.
          description: Prefill a DATE field with today’s date (local time).
        - type: object
          required: [op, dependsOn]
          properties:
            op:
              type: string
              enum: [copy]
              description: Copy the value from another field (useful for numeric defaults).
            dependsOn:
              type: string
              description: ID of the source field whose value should be copied into the target.
            applyOn:
              type: string
              enum: [change, blur]
              description: |
                When to apply the derived value during editing.
                - blur: default for copy (avoids mid-typing updates; applies when the user leaves the field)
                - change: apply on every keystroke/change
            when:
              type: string
              enum: [always, empty]
              description: |
                When to apply the derived value.
                - empty: default for copy (behaves like a default; allows user overrides)
                - always: keep the target in sync with the source field
            copyMode:
              type: string
              enum: [replace, allowIncrease, allowDecrease]
              description: |
                Optional copy mode for numeric values (only applies when `when: "always"`):
                - replace: direct copy (default)
                - allowIncrease: user can increase above source, but never below it (clamps to source on blur)
                - allowDecrease: user can decrease below source, but never above it (clamps to source on blur)
            hidden:
              type: boolean
              description: Informational flag to mark the field as system-managed/hidden in UI.
          description: Copy a field value from another field (typically for NUMBER defaults).
        - type: object
          required: [op, thresholds]
          properties:
            op:
              type: string
              enum: [timeOfDayMap]
              description: Map the current time-of-day (or a source date/time field) into a target value using thresholds.
            dependsOn:
              type: string
              description: Optional source field ID used to read a date/time value. When omitted, current time ("now") is used.
            thresholds:
              type: array
              description: |
                Threshold mapping evaluated in ascending order: the first entry where current time-of-day < before wins.
                The last entry may omit `before` to act as the fallback.
              items:
                type: object
                properties:
                  before:
                    oneOf:
                      - type: string
                        description: Threshold time (local) such as "10h", "12:30".
                      - type: integer
                        description: Threshold hour (e.g., 10 means 10h; values > 24 are treated as minutes since midnight).
                  value:
                    type: string
                    description: Value to set on the target field when the threshold matches.
                required: [value]
            when:
              type: string
              enum: [always, empty]
              description: |
                When to apply the derived value.
                - empty: default for timeOfDayMap (prefill/default behavior)
                - always: recompute on every change
            hidden:
              type: boolean
              description: Informational flag to mark the field as system-managed/hidden in UI.
          description: Map time-of-day to a value (e.g., auto-select SHIFT or a status label).

    DataSourceConfig:
      type: object
      properties:
        id:
          type: string
          description: Identifier to look up a backend data source (passed to Apps Script `fetchDataSource`).
        ref:
          type: string
          description: Optional reference key to disambiguate multiple sources.
        mode:
          type: string
          enum: [options, prefill, list]
          description: Whether the source populates options, prefills values/line items, or serves list views.
        sheetId:
          type: string
          description: Optional sheet id when sourcing from another spreadsheet file.
        tabName:
          type: string
          description: Tab name for the source table.
        localeKey:
          type: string
          description: Optional column used to scope localized rows.
        limit:
          type: integer
          description: Optional max rows to read (default 50; hard cap 200).
        projection:
          type: array
          items:
            type: string
          description: Limit columns returned from the data source.
        mapping:
          type: object
          additionalProperties:
            type: string
          description: Optional map from source column -> target field id (used for prefill/line-item injection).
        tooltipField:
          type: string
          description: Optional column name to surface as tooltip text for each option (shown in form + summary).
        tooltipLabel:
          $ref: '#/components/schemas/LocalizedString'
          description: |
            Optional localized label/title to show on the tooltip trigger and overlay header for fields using this data source.
      required: [id]
      example:
        id: recipes
        sheetId: 1AbcDEF_sheet_id_here
        tabName: Recipes Data
        projection: [name_en, ingredient, quantity, unit]
        localeKey: locale
        limit: 100
        mode: prefill
        mapping:
          ingredient: ingredient
          quantity: qty
          unit: unit

    DashboardConfig:
      type: object
      description: JSON stored in the dashboard’s “Follow-up Config (JSON)” column.
      properties:
        pdfTemplateId:
          $ref: '#/components/schemas/TemplateIdMap'
        pdfFolderId:
          type: string
        emailTemplateId:
          $ref: '#/components/schemas/TemplateIdMap'
        emailSubject:
          $ref: '#/components/schemas/LocalizedString'
        emailRecipients:
          type: array
          items:
            $ref: '#/components/schemas/EmailRecipientEntry'
        emailCc:
          type: array
          items:
            $ref: '#/components/schemas/EmailRecipientEntry'
        emailBcc:
          type: array
          items:
            $ref: '#/components/schemas/EmailRecipientEntry'
        statusFieldId:
          type: string
        statusTransitions:
          $ref: '#/components/schemas/FollowupStatusConfig'
        listViewMetaColumns:
          type: array
          items:
            type: string
            enum: [createdAt, updatedAt, status, pdfUrl]
      additionalProperties: true

    TemplateIdMap:
      oneOf:
        - type: string
        - type: object
          additionalProperties:
            type: string

    LocalizedString:
      oneOf:
        - type: string
        - type: object
          additionalProperties:
            type: string

    EmailRecipientEntry:
      oneOf:
        - type: string
        - $ref: '#/components/schemas/EmailRecipientDataSourceConfig'

    EmailRecipientDataSourceConfig:
      type: object
      required: [type, recordFieldId, lookupField, valueField, dataSource]
      properties:
        type:
          type: string
          enum: [dataSource]
        recordFieldId:
          type: string
        lookupField:
          type: string
        valueField:
          type: string
        dataSource:
          $ref: '#/components/schemas/DataSourceConfig'
        fallbackEmail:
          type: string

    FollowupStatusConfig:
      type: object
      properties:
        onPdf:
          type: string
        onEmail:
          type: string
        onClose:
          type: string

    ListViewColumnConfig:
      type: object
      properties:
        fieldId:
          type: string
        label:
          oneOf:
            - type: string
            - type: object
              additionalProperties:
                type: string
        kind:
          type: string
          enum: [question, meta]
          description: Distinguishes user-defined question columns from system meta columns (Created/Updated/Status/PDF).
      required:
        - fieldId

    ListViewConfig:
      type: object
      properties:
        title:
          oneOf:
            - type: string
            - type: object
              additionalProperties:
                type: string
          description: Optional localized heading displayed above the list view.
        columns:
          type: array
          items:
            $ref: '#/components/schemas/ListViewColumnConfig'
        metaColumns:
          type: array
          description: System columns appended after question columns.
          items:
            type: string
            enum: [createdAt, updatedAt, status, pdfUrl]
        defaultSort:
          type: object
          properties:
            fieldId:
              type: string
            direction:
              type: string
              enum: [asc, desc]
        pageSize:
          type: integer
          description: Max rows per page (default 10, capped at 50).
      required:
        - columns
      description: Configuration for list views showing saved submissions.
      example:
        columns:
          - fieldId: dishName
          - fieldId: createdAt
            label:
              en: Created
              fr: Créé
        defaultSort:
          fieldId: createdAt
          direction: desc
        pageSize: 10


    DedupRule:
      type: object
      properties:
        id:
          type: string
        scope:
          type: string
          description: A `form` (default) or a `dataSourceId` if dedup checks another tab.
        keys:
          type: array
          items:
            type: string
          description: Field ids forming the uniqueness composite.
        matchMode:
          type: string
          enum: [exact, caseInsensitive]
          default: exact
        onConflict:
          type: string
          enum: [reject, ignore, merge]
          default: reject
        message:
          oneOf:
            - type: string
            - type: object
              additionalProperties:
                type: string
          description: User-facing error when `onConflict=reject`.
        mergeHandlerKey:
          type: string
          description: Only used when `onConflict=merge` to look up custom merge logic.
      required:
        - id
        - keys
      description: Deduplication rules evaluated at submission time.
      example:
        id: uniqueDishPerDay
        scope: form
        keys: [dishName, serviceDate]
        matchMode: caseInsensitive
        onConflict: reject
        message:
          en: This dish is already recorded for that date.
    DedupSheet:
      type: array
      description: |
        Optional per-form dedup sheet named "<ConfigSheetName> Dedup" with columns:
        1) Rule ID, 2) Scope (form or dataSourceId), 3) Keys (comma-separated field ids),
        4) Match mode (exact|caseInsensitive), 5) On conflict (reject|ignore|merge),
        6) Message (string or localized JSON).
      items:
        type: object
        properties:
          ruleId:
            type: string
          scope:
            type: string
          keys:
            type: string
          matchMode:
            type: string
          onConflict:
            type: string
          message:
            type: string

    PaginatedResult:
      type: object
      properties:
        items:
          type: array
          items:
            type: object
        nextPageToken:
          type: string
        totalCount:
          type: integer
      required:
        - items
      description: Generic paginated response wrapper for list endpoints (totalCount capped at 200).

    RecordMetadata:
      type: object
      properties:
        id:
          type: string
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    SelectionEffect:
      type: object
      properties:
        type:
          type: string
          enum: [addLineItems, addLineItemsFromDataSource]
          description: |
            Effect type. `addLineItems` inserts rows with static presets.
            `addLineItemsFromDataSource` hydrates rows by looking up the selected value inside a data source row (supports JSON columns).
        groupId:
          type: string
          description: Target LINE_ITEM_GROUP id where rows are added.
        preset:
          type: object
          additionalProperties:
            type: [string, number]
          description: Optional preset values for line-item fields when rows are added.
        triggerValues:
          type: array
          items:
            type: string
          description: Choice/checkbox values that trigger the effect (omit to trigger on any selection).
        dataSource:
          $ref: '#/components/schemas/DataSourceConfig'
          description: Optional override for data-driven effects. Defaults to the question's own `dataSource`.
        lookupField:
          type: string
          description: Column/field used to match the selected value when `type=addLineItemsFromDataSource`.
        dataField:
          type: string
          description: Column/field that contains the serialized payload (typically JSON) used to create the line item rows.
        lineItemMapping:
          type: object
          additionalProperties:
            type: string
          description: Map of line item field ids to keys/paths inside each JSON entry (dot notation supported). Prefix with `$row.` to pull from the originating line-item row instead of the data-source payload.
        clearGroupBeforeAdd:
          type: boolean
          description: When true (default) the target line item group is cleared before new rows are inserted.
        aggregateBy:
          type: array
          items:
            type: string
          description: Explicit list of line item field ids to treat as grouping keys (non-numeric). Rows with the same values across these fields are merged.
        aggregateNumericFields:
          type: array
          items:
            type: string
          description: Line item field ids whose values should be summed even if their underlying line item field type is not NUMBER.
        rowMultiplierFieldId:
          type: string
          description: ID of the originating line-item field whose numeric value scales the generated rows (e.g., MEALS in a batch row).
        dataSourceMultiplierField:
          type: string
          description: Column/field in the data source row representing the baseline quantity used to normalize the multiplier (e.g., "Meals" column in the recipe sheet).
        scaleNumericFields:
          type: array
          items:
            type: string
          description: Explicit list of mapped line-item field ids whose numeric values should be multiplied by the computed scale factor. Defaults to `aggregateNumericFields` when omitted.

    VisibilityCondition:
      type: object
      properties:
        fieldId:
          type: string
        equals:
          oneOf:
            - type: string
            - type: array
              items:
                type: string
        greaterThan:
          oneOf:
            - type: number
            - type: string
        lessThan:
          oneOf:
            - type: number
            - type: string

    VisibilityConfig:
      type: object
      properties:
        showWhen:
          $ref: '#/components/schemas/VisibilityCondition'
        hideWhen:
          $ref: '#/components/schemas/VisibilityCondition'
      description: Show/hide logic tied to another field value.

    LineItemSelectorConfig:
      type: object
      properties:
        id:
          type: string
          description: ID used by option filters or validation rules to read the selector value.
        labelEn:
          type: string
        labelFr:
          type: string
        labelNl:
          type: string
        optionsRef:
          type: string
          description: REF:TabName pointing to a 3-column list of options for the selector.
        options:
          type: array
          items:
            type: string
        optionsFr:
          type: array
          items:
            type: string
        optionsNl:
          type: array
          items:
            type: string
        required:
          type: boolean
          description: Whether the selector is required before adding lines.

    LineItemTotalConfig:
      type: object
      properties:
        type:
          type: string
          enum: [sum, count]
          description: Use `sum` to add numeric field values or `count` to count rows.
        fieldId:
          type: string
          description: Line item field ID to sum (ignored for `count`).
        label:
          oneOf:
            - type: string
            - type: object
              additionalProperties:
                type: string
          description: Optional label shown before the aggregated value (supports localization keys).
        decimalPlaces:
          type: integer
          description: Optional decimal precision for totals.

    ValidationRule:
      type: object
      properties:
        when:
          type: object
          properties:
            fieldId:
              type: string
            equals:
              oneOf:
                - type: string
                - type: array
                  items:
                    type: string
            greaterThan:
              oneOf:
                - type: number
                - type: string
            lessThan:
              oneOf:
                - type: number
                - type: string
        then:
          type: object
          properties:
            fieldId:
              type: string
            required:
              type: boolean
              description: If true, target field must have a value when the condition matches.
            min:
              oneOf:
                - type: number
                - type: string
              description: Enforce target numeric value >= min.
            minFieldId:
              type: string
              description: Enforce target numeric value >= the numeric value of another field (skips if the referenced field is empty/non-numeric). If both `min` and `minFieldId` are set, `min` wins.
            max:
              oneOf:
                - type: number
                - type: string
              description: Enforce target numeric value <= max.
            maxFieldId:
              type: string
              description: Enforce target numeric value <= the numeric value of another field (skips if the referenced field is empty/non-numeric). If both `max` and `maxFieldId` are set, `max` wins.
            allowed:
              type: array
              items:
                type: string
            disallowed:
              type: array
              items:
                type: string
        message:
          oneOf:
            - type: string
            - type: object
              properties:
                en:
                  type: string
                fr:
                  type: string
                nl:
                  type: string
              additionalProperties:
                type: string
        phase:
          type: string
          enum: [submit, followup, both]
          description: Optional scope; defaults to "both". Use "followup" to enforce a rule only during follow-up actions (e.g., require FINAL_QTY then).
      required:
        - when
        - then
      description: Cross-field validation rule to enforce allowed/disallowed combinations.
      example:
        when:
          fieldId: Product
          equals: Carrots
        then:
          fieldId: Unit
          allowed: [Crates]
        message: Carrots must be recorded in crates.

    LineItemSheet:
      type: array
      description: |
        Structure of the separate sheet referenced by `REF:SheetName` for LINE_ITEM_GROUP questions.
        Columns should be: ID, Type, Label EN, Label FR, Label NL, Required?, Options (EN), Options (FR), Options (NL), Config JSON.
        Type must be one of DATE, TEXT, PARAGRAPH, NUMBER, CHOICE, CHECKBOX.
        The Config JSON (column 10) can optionally include `optionFilter` and/or `validationRules` per line-item field.
      items:
        type: object
        properties:
          id:
            type: string
          type:
            type: string
            enum: [DATE, TEXT, PARAGRAPH, NUMBER, CHOICE, CHECKBOX]
          labelEn:
            type: string
          labelFr:
            type: string
          labelNl:
            type: string
          required:
            type: boolean
          options:
            type: string
            description: Option values for CHOICE/CHECKBOX in English, or REF:Options_sheet.
          optionsFr:
            type: string
          optionsNl:
            type: string

    OptionsSheet:
      type: array
      description: |
        Structure of the separate sheet referenced by `REF:SheetName`.
        Contains three columns defining options in each language.
      items:
        type: object
        properties:
          optionEn:
            type: string
            description: Option text in English (Column A).
          optionFr:
            type: string
            description: Option text in French (Column B).
          optionNl:
            type: string
            description: Option text in Dutch (Column C).

    ConfigSheet:
      type: array
      description: A collection of question configurations defining a form.
      items:
        $ref: '#/components/schemas/QuestionConfig'
